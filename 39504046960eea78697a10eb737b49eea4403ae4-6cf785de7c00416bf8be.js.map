{"version":3,"sources":["webpack://jacdac-docs/./jacdac-ts/src/vm/environment.ts","webpack://jacdac-docs/./jacdac-ts/src/vm/expr.ts","webpack://jacdac-docs/./src/components/services/useServiceRole.ts","webpack://jacdac-docs/./src/components/services/ServiceRole.tsx","webpack://jacdac-docs/./src/components/dashboard/DashboardServiceWidgetItem.tsx","webpack://jacdac-docs/./src/components/dashboard/DashboardServiceDetails.tsx","webpack://jacdac-docs/./src/components/hooks/useIntersectionObserver.ts","webpack://jacdac-docs/./src/components/dashboard/DashboardDevice.tsx","webpack://jacdac-docs/./src/components/services/useRoleManager.ts"],"names":["refresh_env","registers","k","register","retry","val","undefined","refresh","unpackedValue","writeReg","reg","fmt","ev","sendSetPackedAsync","VMServiceEnvironment","service","_registers","_events","registerRegister","regName","handler","pkt","specification","packets","find","isRegister","name","identifier","mount","subscribe","CHANGE","registerEvent","eventName","isEvent","event","EVENT","writeRegister","jdreg","packFormat","lookup","e","root","type","object","fld","property","field","fields","f","value","refreshEnvironment","JDServiceClient","VMEnvironment","bus","notifyOnChange","_currentEvent","_services","_locals","getRootName","nameMatch","n1","n2","cn1","slice","toLowerCase","replace","trim","cn2","getServiceFromName","services","s","shortName","getService","Object","values","forEach","roleName","me","local","serviceEnv","writeLocal","consumeEvent","hasEvent","unsubscribe","vs","unmount","JDEventSource","unparse","ae","elements","map","join","caller","callee","arguments","computed","be","left","operator","right","ue","argument","raw","JDExprEvaluator","env","callEval","exprStack","tos","length","pop","eval","visitExpression","ret","push","top","le","id","lit","useServiceRole","useState","role","setRole","useEffect","ROLE_CHANGE","ServiceRole","props","useContext","AppContext","showSelectRoleDialog","roleManager","useRoleManager","handleClick","hasRoleForService","useChange","_","DashboardServiceWidgetItem","useRegisterUnpackedValue","SystemReg","instanceName","float","ignoreRegisters","collapsedRegisters","DashboardServiceDetails","expanded","visible","spec","useMemo","ids","filter","indexOf","optional","kind","lastGetAttempts","REGISTER_OPTIONAL_POLL_COUNT","useIntersectionObserver","elementRef","options","entry","setEntry","threshold","rootMargin","freezeOnceVisible","frozen","isIntersecting","updateEntry","node","current","hasIOSupport","window","IntersectionObserver","observerParams","observer","observe","disconnect","ignoredServices","SRV_CONTROL","SRV_LOGGER","SRV_SETTINGS","SRV_PROTO_TEST","DashboardDevice","device","serviceFilter","toggleExpanded","variant","showAvatar","showHeader","useDeviceName","serviceClass","useDeviceSpecification","useMediaQueries","mobile","xs","serviceGridRef","useRef","intersection","useSnackbar","enqueueSnackbar","RESTART","console","debug","shortId","ServiceWidgets","useCallback","srv","isMixin","dependencyId","padding","paddingBottom","paddingTop","serviceIndex","JacdacContext","mgr","setMgr","ROLE_MANAGER_CHANGE"],"mappings":"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","file":"39504046960eea78697a10eb737b49eea4403ae4-6cf785de7c00416bf8be.js","sourcesContent":["import {\n    isEvent,\n    isRegister\n} from \"../jdom/spec\"\nimport { JDEvent } from \"../jdom/event\"\nimport { JDServiceClient } from \"../jdom/serviceclient\"\nimport { JDRegister } from \"../jdom/register\"\nimport { SMap } from \"../jdom/utils\"\nimport { JDBus } from \"../jdom/bus\"\nimport { JDService } from \"../jdom/service\"\nimport { JDEventSource } from \"../jdom/eventsource\"\nimport { \n    CHANGE, \n    EVENT,\n} from \"../jdom/constants\"\n\nexport async function refresh_env(registers: SMap<JDRegister>) {\n    for (const k in registers) {\n        const register = registers[k]\n        let retry = 0\n        let val: any = undefined\n        do {\n            await register.refresh()\n            val = register.unpackedValue?.[0]\n        } while (val === undefined && retry++ < 2)\n    }\n}\n\n// TODO: you want [ev] to be PackedValues and handle the arrays yourself.\nasync function writeReg(reg: JDRegister, fmt: string, ev: any) {\n    await reg.sendSetPackedAsync(fmt, [ev], true)\n}\n\nexport class VMServiceEnvironment extends JDServiceClient {\n    private _registers: SMap<JDRegister> = {}\n    private _events: SMap<JDEvent> = {}\n\n    constructor(service: JDService) {\n        super(service)\n    }\n\n    public registerRegister(regName: string, handler: () => void ) {\n        if (!this._registers[regName]) {\n            const pkt = this.service.specification.packets.find(\n                pkt => isRegister(pkt) && pkt.name === regName\n            )\n            if (pkt) {\n                const register = this.service.register(pkt.identifier)\n                this._registers[regName] = register\n                this.mount(\n                    register.subscribe(CHANGE, handler )\n                )\n            }\n        }\n    }\n\n    public registerEvent(eventName: string, handler: () => void ) {\n        if (!this._events[eventName]) {\n            const pkt = this.service.specification.packets.find(\n                pkt => isEvent(pkt) && pkt.name === eventName\n            )\n            if (pkt) {\n                const event = this.service.event(pkt.identifier)\n                this._events[eventName] = event\n                this.mount(\n                    event.subscribe(EVENT, handler )\n                )\n            }\n        }\n    }\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    public writeRegister(regName: string, ev: any) {\n        const jdreg = this._registers[ regName ] \n        if (jdreg) {\n            writeReg(jdreg, jdreg.specification?.packFormat, ev)\n            return true\n        }\n        return false\n    }\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    public lookup(e: jsep.MemberExpression | jsep.Identifier | string): any {\n        let root = typeof(e) === \"string\" ? e : (e.type === \"Identifier\" ? e.name : (e.object as jsep.Identifier).name)\n        let fld = typeof(e) === \"string\" ? undefined : (e.type === \"Identifier\" ? undefined : (e.property as jsep.Identifier).name)\n        if (root in this._registers) {\n            if (!fld) return this._registers[root].unpackedValue?.[0]\n            else {\n                const field = this._registers[root].fields.find(\n                    f => f.name === fld\n                )\n                return field?.value\n            }\n        } else if (root in this._events) {\n            const field = this._events[root].fields?.find(f => f.name === fld)\n            return field?.value\n        }\n        return undefined\n    }\n    \n    public refreshEnvironment() {\n        refresh_env(this._registers)\n    }\n}\n\n\nexport class VMEnvironment extends JDEventSource  {\n    private _currentEvent: string = undefined\n    private _services: SMap<VMServiceEnvironment> = {}\n    private _locals: SMap<string> = {}\n\n    constructor(private readonly bus: JDBus, private readonly notifyOnChange: () => void) {\n        super()\n    }\n\n    private getRootName(e: jsep.MemberExpression | string) {\n        if (!e || typeof(e) === \"string\" || e.type !== \"MemberExpression\")\n            return undefined\n        return (e.object as jsep.Identifier).name\n    }\n\n    private nameMatch(n1: string, n2: string) {\n        const cn1 = n1.slice(0).toLowerCase().replace(\"_\",\" \").trim()\n        const cn2 = n2.slice(0).toLowerCase().replace(\"_\",\" \").trim()\n        return cn1 === cn2\n    }\n    \n    private getServiceFromName(root: string): JDService {\n        // policy for resolution goes here\n        return this.bus.services().find(s => this.nameMatch(s.specification.shortName, root))\n    }\n\n    private getService(e: jsep.MemberExpression | string) {\n        const root = this.getRootName(e)\n        if (!root)\n            return undefined;\n        if (!this._services[root]) {\n            const service = this.getServiceFromName(root);\n            if (service) {\n                this._services[root] = new VMServiceEnvironment(service)\n            } else  \n                return undefined\n        }\n        return this._services[root]\n    }\n\n    public refreshEnvironment() {\n        Object.values(this._services).forEach(s => s.refreshEnvironment())\n    }\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    public lookup(e: jsep.MemberExpression | string): any {\n        const roleName = this.getRootName(e)\n        if (roleName === \"$\") {\n            let me = e as jsep.MemberExpression\n            if (me.property.type === \"Identifier\") {\n                const local = (me.property as jsep.Identifier).name\n                return this._locals[local]\n            }\n            return undefined;\n        }\n        const serviceEnv = this.getService(e)\n        if (!serviceEnv)\n            return undefined\n        const me = e as jsep.MemberExpression\n        if (serviceEnv && me.property.type === \"Identifier\") {\n            const reg = (me.property as jsep.Identifier).name\n            serviceEnv.registerRegister(reg, this.notifyOnChange);\n            return serviceEnv.lookup(reg)\n        }\n        return undefined\n    }\n\n    // TODO: need do a notify\n    public writeRegister(e: jsep.MemberExpression | string, ev: any) {\n        const serviceEnv = this.getService(e)\n        const me = e as jsep.MemberExpression;\n        if (serviceEnv && me.property.type === \"Identifier\") {\n            const reg = (me.property as jsep.Identifier).name\n            serviceEnv.registerRegister(reg, this.notifyOnChange);\n            return serviceEnv.writeRegister(reg, ev);\n        }\n        return false\n    }\n\n    public writeLocal(e: jsep.MemberExpression | string, ev: any) {\n        const roleName = this.getRootName(e)\n        if (!roleName || roleName !== \"$\")\n            return undefined;\n            const me = e as jsep.MemberExpression;\n        if (me.property.type === \"Identifier\") {\n            const local = (me.property as jsep.Identifier).name\n            this._locals[local] = ev\n            return true\n        }\n        return false;\n    }\n\n    public consumeEvent() {\n        this._currentEvent = undefined\n    }\n\n    public hasEvent(e: jsep.MemberExpression | string) {\n        const serviceEnv = this.getService(e)\n        if (!serviceEnv)\n            return false\n        const me = e as jsep.MemberExpression;\n        if (serviceEnv && me.property.type === \"Identifier\") {\n            const event = (me.property as jsep.Identifier).name\n            serviceEnv.registerEvent(event, () => {\n                this._currentEvent = event\n                this.notifyOnChange()\n            });\n            return this._currentEvent === event\n        }\n        return false\n    }\n\n    public unsubscribe() {\n        Object.values(this._services).forEach(vs => vs.unmount())\n    }\n}","\n/*\nThe JD-VM runs a program, which is a set of handlers. Each handler is of the form\n•\twait on event/condition, followed by a\n•\tsequence of guarded commands – the sequence is executed atomically (though may suspend if it contains a wait)\nAfter a handler finishes executing, it restarts (there is an implicit event loop around all the handlers, as usual). \n \nWe will have a small key-value store to keep program state (perhaps we will have the ability to store lists of values as well as basic values) across the handler executions.\n \nCommands can talk to JD services (probably via roles), as well as read/write program state, and wait on events/expressions. Any command can be guarded by an expression, for conditional execution.\n \nExpressions can be against service registers (as in the test case) and program state.\n \n*/\n\nexport type GetValue = (e: jsep.MemberExpression | string) => any\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport type StartMap = { e: jsep.Expression; v: any }[]\n\nexport type CallEvaluator = (ce: jsep.CallExpression, ee: JDExprEvaluator) => any\n\nexport function unparse(e: jsep.Expression): string {\n    switch (e.type) {\n        case \"ArrayExpression\": {\n            const ae = e as jsep.ArrayExpression\n            return `[${ae.elements.map(unparse).join(\", \")}]`\n        }\n        case \"CallExpression\": {\n            const caller = e as jsep.CallExpression\n            return `${unparse(caller.callee)}(${caller.arguments\n                .map(unparse)\n                .join(\", \")})`\n        }\n        case \"MemberExpression\": {\n            const root = e as jsep.MemberExpression\n            return root.computed\n                ? `${unparse(root.object)}[${unparse(root.property)}]`\n                : `${unparse(root.object)}.${unparse(root.property)}`\n        }\n        case \"BinaryExpression\":\n        case \"LogicalExpression\": {\n            const be = e as any\n            return `(${unparse(be.left)} ${be.operator} ${unparse(be.right)})`\n        }\n        case \"UnaryExpression\": {\n            const ue = e as jsep.UnaryExpression\n            return `${ue.operator}${unparse(ue.argument)}`\n        }\n        case \"Identifier\": {\n            return (e as jsep.Identifier).name\n        }\n        case \"Literal\": {\n            return (e as jsep.Literal).raw\n        }\n        default:\n            return \"TODO\"\n    }\n}\n\nexport class JDExprEvaluator {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    private exprStack: any[] = []\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    constructor(private env: GetValue, private callEval: CallEvaluator) {}\n\n    public tos() {\n        return this.exprStack[this.exprStack.length - 1]\n    }\n\n    public pop() {\n        return this.exprStack.pop()\n    }\n\n    public eval(e: jsep.Expression) {\n        this.exprStack = []\n        this.visitExpression(e)\n        return this.exprStack.pop()\n    }\n\n    public visitExpression(e: jsep.Expression) {\n        switch (e.type) {\n            case \"ArrayExpression\": {\n                // nothing to do here yet (only used for event function)\n                break\n            }\n\n            case \"CallExpression\": {\n                if (this.callEval) {\n                    let ret = this.callEval(<jsep.CallExpression>e, this);\n                    this.exprStack.push(ret)\n                } else\n                    this.exprStack.push(undefined)\n                break\n            }\n\n            case \"BinaryExpression\": {\n                const be = <jsep.BinaryExpression>e\n                this.visitExpression(be.left)\n                this.visitExpression(be.right)\n                const right = this.exprStack.pop()\n                const left = this.exprStack.pop()\n                switch (be.operator) {\n                    case \"+\":\n                        this.exprStack.push(left + right)\n                        return\n                    case \"-\":\n                        this.exprStack.push(left - right)\n                        return\n                    case \"/\":\n                        this.exprStack.push(left / right)\n                        return\n                    case \"*\":\n                        this.exprStack.push(left * right)\n                        return\n                    case \"%\":\n                        this.exprStack.push(left % right)\n                        return\n                    case \">>\":\n                        this.exprStack.push(left >> right)\n                        return\n                    case \">>>\":\n                        this.exprStack.push(left >>> right)\n                        return\n                    case \"<<\":\n                        this.exprStack.push(left << right)\n                        return\n                    case \"|\":\n                        this.exprStack.push(left | right)\n                        return\n                    case \"&\":\n                        this.exprStack.push(left & right)\n                        return\n                    case \"^\":\n                        this.exprStack.push(left ^ right)\n                        return\n                    case \"==\":\n                        this.exprStack.push(left == right)\n                        return\n                    case \"!=\":\n                        this.exprStack.push(left != right)\n                        return\n                    case \"===\":\n                        this.exprStack.push(left === right)\n                        return\n                    case \"!==\":\n                        this.exprStack.push(left !== right)\n                        return\n\n                    case \"<\":\n                        this.exprStack.push(left < right)\n                        return\n                    case \">\":\n                        this.exprStack.push(left > right)\n                        return\n                    case \"<=\":\n                        this.exprStack.push(left <= right)\n                        return\n                    case \">=\":\n                        this.exprStack.push(left >= right)\n                        return\n                }\n                break\n            }\n\n            case \"UnaryExpression\": {\n                const ue = <jsep.UnaryExpression>e\n                this.visitExpression(ue.argument)\n                const top = this.exprStack.pop()\n                switch (ue.operator) {\n                    case \"!\":\n                        this.exprStack.push(!top)\n                        return\n                    case \"~\":\n                        this.exprStack.push(~top)\n                        return\n                    case \"-\":\n                        this.exprStack.push(-top)\n                        return\n                    case \"+\":\n                        this.exprStack.push(+top)\n                        return\n                }\n                break\n            }\n\n            case \"LogicalExpression\": {\n                const le = <jsep.LogicalExpression>e\n                this.visitExpression(le.left)\n                switch (le.operator) {\n                    case \"||\":\n                        if (this.tos()) return\n                        else this.visitExpression(le.right)\n                        return\n                    case \"&&\":\n                        if (!this.tos()) return\n                        else this.visitExpression(le.right)\n                        return\n                    default:\n                }\n                break\n            }\n            case \"MemberExpression\": {\n                // for now, we don't support evaluation of obj or prop \n                // of obj.prop\n                const val = this.env(e as jsep.MemberExpression)\n                this.exprStack.push(val)\n                return\n            }\n            case \"Identifier\": {\n                const id = <jsep.Identifier>e\n                this.exprStack.push(this.env(id.name))\n                return\n            }\n            case \"Literal\": {\n                const lit = <jsep.Literal>e\n                this.exprStack.push(lit.value)\n                return\n            }\n            default:\n        }\n    }\n}\n","import { useEffect, useState } from \"react\"\nimport { ROLE_CHANGE } from \"../../../jacdac-ts/src/jdom/constants\"\nimport { JDService } from \"../../../jacdac-ts/src/jdom/service\"\n\nexport default function useServiceRole(service: JDService) {\n    const [role, setRole] = useState<string>(service?.role);\n    useEffect(() => service?.subscribe(ROLE_CHANGE, () => {\n        setRole(service.role)\n    }), [service])\n    return role;\n}","import { Button } from \"@material-ui/core\"\nimport React, { useContext } from \"react\"\nimport { JDService } from \"../../../jacdac-ts/src/jdom/service\"\nimport useChange from \"../../jacdac/useChange\"\nimport AppContext from \"../AppContext\"\nimport useRoleManager from \"./useRoleManager\"\nimport useServiceRole from \"./useServiceRole\"\n\nexport default function ServiceRole(props: { service: JDService }) {\n    const { service } = props\n    const { showSelectRoleDialog } = useContext(AppContext)\n    const roleManager = useRoleManager()\n    const role = useServiceRole(service)\n    const handleClick = () => showSelectRoleDialog(service)\n\n    const hasRoleForService = useChange(roleManager, _ => _?.hasRoleForService(service))\n    // hide if no role manager or role not compatible with required roles\n    if (!hasRoleForService)\n        return null;\n\n    return <Button size=\"small\" onClick={handleClick}>{role || \"...\"}</Button>\n}\n","import { Grid, Typography } from \"@material-ui/core\"\nimport React from \"react\"\nimport DashboardServiceWidget, {\n    DashboardServiceProps,\n} from \"./DashboardServiceWidget\"\nimport ServiceRole from \"../services/ServiceRole\"\nimport { useRegisterUnpackedValue } from \"../../jacdac/useRegisterValue\"\nimport { SystemReg } from \"../../../jacdac-ts/src/jdom/constants\"\n\nexport default function DashboardServiceWidgetItem(\n    props: React.Attributes & DashboardServiceProps\n): JSX.Element {\n    const { service } = props\n    const [instanceName] = useRegisterUnpackedValue<[number]>(\n        service.register(SystemReg.InstanceName),\n        props\n    )\n\n    return (\n        <Grid item>\n            <Grid container spacing={1} alignItems=\"center\">\n                <Grid item xs>\n                    <ServiceRole service={service} />\n                </Grid>\n                {instanceName && (\n                    <Grid item>\n                        <Typography\n                            className=\"no-pointer-events\"\n                            variant=\"caption\"\n                            component=\"span\"\n                            style={{ float: \"right\" }}\n                        >\n                            {instanceName}\n                        </Typography>\n                    </Grid>\n                )}\n            </Grid>\n            <DashboardServiceWidget {...props} />\n        </Grid>\n    )\n}\n","import React, { useMemo } from \"react\"\nimport {\n    REGISTER_OPTIONAL_POLL_COUNT,\n    SystemReg,\n} from \"../../../jacdac-ts/src/jdom/constants\"\nimport useChange from \"../../jacdac/useChange\"\nimport RegisterInput from \"../RegisterInput\"\nimport { isRegister } from \"../../../jacdac-ts/src/jdom/spec\"\nimport { DashboardServiceProps } from \"./DashboardServiceWidget\"\nimport { Grid } from \"@material-ui/core\"\nimport { JDRegister } from \"../../../jacdac-ts/src/jdom/register\"\n\n// filter out common registers\nconst ignoreRegisters = [\n    SystemReg.StatusCode,\n    SystemReg.StreamingPreferredInterval,\n    SystemReg.StreamingSamples,\n    SystemReg.StreamingInterval,\n]\nconst collapsedRegisters = [\n    SystemReg.Reading,\n    SystemReg.Value,\n    SystemReg.Intensity,\n]\n\nexport default function DashboardServiceDetails(props: DashboardServiceProps) {\n    const { service, expanded, visible } = props\n    const specification = useChange(service, spec => spec.specification)\n    const registers: JDRegister[] = useMemo(() => {\n        const packets = specification?.packets\n        let ids =\n            packets\n                ?.filter(pkt => isRegister(pkt))\n                ?.map(pkt => pkt.identifier) || []\n        ids = ids.filter(id => ignoreRegisters.indexOf(id) < 0)\n        if (!expanded)\n            // grab the first interresting register\n            ids = ids\n                .filter(id => collapsedRegisters.indexOf(id) > -1)\n                .slice(0, 1)\n        return (\n            ids\n                .map(id => service.register(id))\n                .filter(reg => !!reg)\n                // hide optional const register without values\n                .filter(\n                    reg =>\n                        !reg.specification?.optional ||\n                        (reg.specification?.kind === \"const\" &&\n                            reg.lastGetAttempts < REGISTER_OPTIONAL_POLL_COUNT)\n                )\n        )\n    }, [specification, expanded])\n\n    if (!registers?.length)\n        // nothing to see here\n        return null\n\n    return (\n        <>\n            {registers.map(register => {\n                return (\n                    <Grid key={register.id} item xs={true}>\n                        <RegisterInput\n                            register={register}\n                            showServiceName={true}\n                            showRegisterName={true}\n                            hideMissingValues={false}\n                            showTrend={false}\n                            visible={visible}\n                        />\n                    </Grid>\n                )\n            })}\n        </>\n    )\n}\n","import { useEffect, useState, RefObject } from 'react'\n\nexport interface Args extends IntersectionObserverInit {\n  freezeOnceVisible?: boolean\n}\n\nexport default function useIntersectionObserver(\n  elementRef: RefObject<Element>,\n  options?: { freezeOnceVisible?: boolean } & IntersectionObserverInit\n): IntersectionObserverEntry | undefined {\n  const [entry, setEntry] = useState<IntersectionObserverEntry>()\n  const { threshold = 0, root = null, rootMargin = '0%', freezeOnceVisible } = options || {};\n\n  const frozen = entry?.isIntersecting && freezeOnceVisible\n\n  const updateEntry = ([entry]: IntersectionObserverEntry[]): void => {\n    setEntry(entry)\n  }\n\n  useEffect(() => {\n    const node = elementRef?.current // DOM Ref\n    const hasIOSupport = !!window.IntersectionObserver\n\n    if (!hasIOSupport || frozen || !node) return\n\n    const observerParams = { threshold, root, rootMargin }\n    const observer = new IntersectionObserver(updateEntry, observerParams)\n\n    //console.log(`observe`, { node })\n    observer.observe(node)\n\n    return () => observer.disconnect()\n\n  }, [elementRef, threshold, root, rootMargin, frozen])\n\n  return entry\n}\n","import {\n    Card,\n    CardContent,\n    CardHeader,\n    Grid,\n    Paper,\n    Typography,\n} from \"@material-ui/core\"\nimport React, { useCallback, useEffect, useRef } from \"react\"\nimport {\n    RESTART,\n    SRV_CONTROL,\n    SRV_LOGGER,\n    SRV_PROTO_TEST,\n    SRV_SETTINGS,\n} from \"../../../jacdac-ts/src/jdom/constants\"\nimport { JDDevice } from \"../../../jacdac-ts/src/jdom/device\"\nimport useChange from \"../../jacdac/useChange\"\nimport DeviceName from \"../devices/DeviceName\"\nimport IconButtonWithTooltip from \"../ui/IconButtonWithTooltip\"\n// tslint:disable-next-line: no-submodule-imports match-default-export-name\nimport ExpandMoreIcon from \"@material-ui/icons/ExpandMore\"\n// tslint:disable-next-line: no-submodule-imports match-default-export-name\nimport ExpandLessIcon from \"@material-ui/icons/ExpandLess\"\nimport useDeviceSpecification from \"../../jacdac/useDeviceSpecification\"\nimport DeviceAvatar from \"../devices/DeviceAvatar\"\nimport DashboardServiceWidgetItem from \"./DashboardServiceWidgetItem\"\nimport DeviceActions from \"../DeviceActions\"\nimport DashboardServiceDetails from \"./DashboardServiceDetails\"\nimport useDeviceName from \"../devices/useDeviceName\"\nimport { DashboardDeviceProps } from \"./Dashboard\"\nimport useIntersectionObserver from \"../hooks/useIntersectionObserver\"\nimport { dependencyId } from \"../../../jacdac-ts/src/jdom/node\"\nimport useMediaQueries from \"../hooks/useMediaQueries\"\nimport { useSnackbar } from \"notistack\"\n\nconst ignoredServices = [SRV_CONTROL, SRV_LOGGER, SRV_SETTINGS, SRV_PROTO_TEST]\n\nexport default function DashboardDevice(\n    props: {\n        device: JDDevice\n        expanded?: boolean\n        toggleExpanded?: () => void\n        variant?: \"icon\" | \"\"\n    } & DashboardDeviceProps\n) {\n    const {\n        device,\n        serviceFilter,\n        expanded,\n        toggleExpanded,\n        variant,\n        showAvatar,\n        showHeader,\n    } = props\n    const name = useDeviceName(device)\n    const services = useChange(device, () =>\n        device\n            .services({ specification: true })\n            .filter(\n                service => ignoredServices.indexOf(service.serviceClass) < 0\n            )\n    )\n    const specification = useDeviceSpecification(device)\n    const { xs: mobile } = useMediaQueries()\n    const serviceGridRef = useRef<HTMLDivElement>()\n    const intersection = useIntersectionObserver(serviceGridRef)\n    const visible = !!intersection?.isIntersecting\n    const { enqueueSnackbar } = useSnackbar()\n\n    useEffect(() =>\n        device?.subscribe(RESTART, () => {\n            console.debug(`${device.shortId} restarted...`)\n            enqueueSnackbar(`${device.shortId} restarted...`, {\n                variant: \"warning\",\n            })\n        })\n    )\n\n    const ServiceWidgets = useCallback(\n        () => (\n            <Grid\n                ref={serviceGridRef}\n                component=\"div\"\n                container\n                spacing={2}\n                justify=\"center\"\n                alignItems=\"flex-end\"\n                alignContent=\"space-between\"\n            >\n                {services\n                    ?.filter(srv => expanded || !srv.isMixin)\n                    ?.filter(srv => !serviceFilter || serviceFilter(srv))\n                    ?.map(service => (\n                        <DashboardServiceWidgetItem\n                            key={service.id}\n                            service={service}\n                            expanded={expanded}\n                            services={services}\n                            variant={variant}\n                            visible={visible}\n                        />\n                    ))}\n            </Grid>\n        ),\n        [dependencyId(services), expanded, variant, visible]\n    )\n\n    if (!showHeader)\n        return (\n            <Paper style={{ padding: \"0.25em\" }} variant=\"outlined\">\n                <ServiceWidgets />\n            </Paper>\n        )\n\n    return (\n        <Card aria-live=\"polite\" aria-label={`device ${name} started`}>\n            <CardHeader\n                style={{ paddingBottom: 0 }}\n                avatar={showAvatar && <DeviceAvatar device={device} />}\n                action={\n                    <DeviceActions\n                        device={device}\n                        showStop={expanded}\n                        hideIdentity={!expanded}\n                        showReset={expanded && !mobile}\n                        showSettings={expanded && !mobile}\n                    >\n                        {toggleExpanded && (\n                            <IconButtonWithTooltip\n                                onClick={toggleExpanded}\n                                title={expanded ? \"Collapse\" : \"Expand\"}\n                            >\n                                {expanded ? (\n                                    <ExpandLessIcon />\n                                ) : (\n                                    <ExpandMoreIcon />\n                                )}\n                            </IconButtonWithTooltip>\n                        )}\n                    </DeviceActions>\n                }\n                title={<DeviceName showShortId={false} device={device} />}\n                subheader={\n                    <>\n                        {!mobile && specification && (\n                            <Typography variant=\"caption\" gutterBottom>\n                                {specification.name}\n                            </Typography>\n                        )}\n                    </>\n                }\n            />\n            <CardContent style={{ paddingTop: 0 }}>\n                <ServiceWidgets />\n                {expanded && (\n                    <Grid\n                        container\n                        direction=\"column\"\n                        spacing={1}\n                        alignContent=\"stretch\"\n                    >\n                        {services?.map(service => (\n                            <DashboardServiceDetails\n                                key={\"details\" + service.serviceIndex}\n                                service={service}\n                                services={services}\n                                expanded={expanded}\n                                variant={variant}\n                                visible={visible}\n                            />\n                        ))}\n                    </Grid>\n                )}\n            </CardContent>\n        </Card>\n    )\n}\n","import { useContext, useEffect, useState } from \"react\"\nimport { ROLE_MANAGER_CHANGE } from \"../../../jacdac-ts/src/jdom/constants\"\nimport { RoleManagerClient } from \"../../../jacdac-ts/src/jdom/rolemanagerclient\"\nimport JacdacContext, { JacdacContextProps } from \"../../jacdac/Context\"\n\nexport default function useRoleManager(): RoleManagerClient {\n    const { bus } = useContext<JacdacContextProps>(JacdacContext)\n    const [mgr, setMgr] = useState<RoleManagerClient>(bus.roleManager)\n    useEffect(() =>\n        bus.subscribe(ROLE_MANAGER_CHANGE, () => setMgr(bus.roleManager))\n    )\n    return mgr\n}\n"],"sourceRoot":""}