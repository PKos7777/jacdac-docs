{"version":3,"file":"component---src-pages-editors-data-tsx-5847cbac51e38d4ecde1.js","mappings":"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","sources":["webpack://jacdac-docs/./src/components/blockly/dsl/iframedsl.ts","webpack://jacdac-docs/./src/components/data-science/DSBlockEditor.tsx","webpack://jacdac-docs/./src/pages/editors/data.tsx"],"sourcesContent":["import { inIFrame } from \"../../../../jacdac-ts/src/jdom/iframeclient\"\nimport { randomDeviceId } from \"../../../../jacdac-ts/src/jdom/random\"\nimport { workspaceToJSON } from \"../jsongenerator\"\nimport {\n    BlockDataSet,\n    BlockDataSetTransform,\n    BlockDefinition,\n    ContentDefinition,\n} from \"../toolbox\"\nimport { setBlockDataWarning } from \"../WorkspaceContext\"\nimport BlockDomainSpecificLanguage, {\n    CreateBlocksOptions,\n    CreateCategoryOptions,\n} from \"./dsl\"\nimport { WorkspaceJSON } from \"./workspacejson\"\n\nexport interface DslMessage {\n    type?: \"dsl\"\n    id: string\n    dslid: string\n    action: \"mount\" | \"unmount\" | \"blocks\" | \"transform\"\n}\n\nexport interface DslBlocksResponse extends DslMessage {\n    action: \"blocks\"\n    blocks: BlockDefinition[]\n    category: ContentDefinition[]\n}\n\nexport interface DslTransformMessage extends DslMessage {\n    action: \"transform\"\n    blockId?: string\n    workspace?: WorkspaceJSON\n    dataset?: BlockDataSet\n}\n\nexport interface DslTransformResponse extends DslTransformMessage {\n    warning?: string\n}\n\nclass IFrameDomainSpecificLanguage implements BlockDomainSpecificLanguage {\n    readonly id = \"iframe\"\n    private dslid = randomDeviceId()\n    private blocks: BlockDefinition[] = []\n    private category: ContentDefinition[] = []\n    private pendings: Record<string, (data: DslMessage) => void> = {}\n\n    constructor(readonly targetOrigin: string) {\n        this.handleMessage = this.handleMessage.bind(this)\n    }\n\n    // eslint-disable-next-line @typescript-eslint/ban-types\n    private post(action: string, extras?: object) {\n        const payload = {\n            id: Math.random() + \"\",\n            type: \"dsl\",\n            dslid: this.dslid,\n            action,\n            ...(extras || {}),\n        } as DslMessage\n        window.parent.postMessage(payload, this.targetOrigin)\n        return payload\n    }\n\n    mount() {\n        window.addEventListener(\"message\", this.handleMessage)\n        this.post(\"mount\")\n        return () => {\n            this.post(\"unmount\")\n            window.removeEventListener(\"message\", this.handleMessage)\n        }\n    }\n\n    private handleMessage(msg: MessageEvent<DslMessage>) {\n        const { data } = msg\n        if (data.type === \"dsl\" && data.dslid === this.dslid) {\n            const { id } = data\n            const pending = this.pendings[id]\n            if (pending) {\n                delete this.pendings[id]\n                pending(data)\n            }\n        }\n    }\n\n    private createTransformData(): BlockDataSetTransform {\n        return (blockWithServices, dataset) =>\n            new Promise<BlockDataSet>(resolve => {\n                const workspace = workspaceToJSON(\n                    blockWithServices.workspace,\n                    [], // TODO pass dsls\n                    [blockWithServices]\n                )\n                const { id } = this.post(\"transform\", {\n                    blockId: blockWithServices.id,\n                    workspace,\n                    dataset,\n                })\n                setTimeout(() => {\n                    if (this.pendings[id]) {\n                        delete this.pendings[id]\n                        console.warn(`iframedsl: transform timeouted`)\n                        resolve(undefined)\n                    }\n                }, 10000)\n                this.pendings[id] = data => {\n                    const { dataset, warning } = data as DslTransformResponse\n                    if (warning) setBlockDataWarning(blockWithServices, warning)\n                    resolve(dataset)\n                }\n            })\n    }\n\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    createBlocks(options: CreateBlocksOptions): Promise<BlockDefinition[]> {\n        console.debug(`iframedsl: query blocks`)\n        return new Promise<BlockDefinition[]>(resolve => {\n            const { id } = this.post(\"blocks\")\n            setTimeout(() => {\n                if (this.pendings[id]) {\n                    delete this.pendings[id]\n                    console.warn(`iframedsl: no blocks returned, giving up`)\n                    resolve(this.blocks)\n                }\n            }, 1000)\n            this.pendings[id] = data => {\n                const bdata = data as DslBlocksResponse\n                this.blocks = bdata.blocks\n                this.category = bdata.category\n                const transformData = this.createTransformData()\n                this.blocks.forEach(\n                    block => (block.transformData = transformData)\n                )\n                resolve(this.blocks)\n            }\n        })\n    }\n\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    createCategory(options: CreateCategoryOptions): ContentDefinition[] {\n        return this.category\n    }\n}\n\n/**\n * Creates an iframe DSL if applicable\n * @param targetOrigin\n * @returns\n */\nexport function createIFrameDSL(\n    targetOrigin = \"*\"\n): BlockDomainSpecificLanguage {\n    return inIFrame() && new IFrameDomainSpecificLanguage(targetOrigin)\n}\n","import { Grid, NoSsr } from \"@material-ui/core\"\nimport React, { useContext, useMemo } from \"react\"\nimport Flags from \"../../../jacdac-ts/src/jdom/flags\"\nimport { BlockProvider } from \"../blockly/BlockContext\"\nimport BlockDiagnostics from \"../blockly/BlockDiagnostics\"\nimport BlockEditor from \"../blockly/BlockEditor\"\nimport FileTabs from \"../fs/FileTabs\"\nimport { WorkspaceFile } from \"../blockly/dsl/workspacejson\"\nimport dataDsl from \"../blockly/dsl/datadsl\"\nimport chartDsl from \"../blockly/dsl/chartdsl\"\nimport fieldsDsl from \"../blockly/dsl/fieldsdsl\"\nimport { WORKSPACE_FILENAME } from \"../blockly/toolbox\"\nimport FileSystemContext from \"../FileSystemContext\"\nimport { createIFrameDSL } from \"../blockly/dsl/iframedsl\"\n\nconst DS_EDITOR_ID = \"ds\"\nconst DS_SOURCE_STORAGE_KEY = \"tools:dseditor\"\nconst DS_NEW_FILE_CONTENT = JSON.stringify({\n    editor: DS_EDITOR_ID,\n    xml: \"\",\n} as WorkspaceFile)\n\nfunction DSEditorWithContext() {\n    const { fileSystem } = useContext(FileSystemContext)\n\n    return (\n        <Grid container direction=\"column\" spacing={1}>\n            {!!fileSystem && (\n                <Grid item xs={12}>\n                    <FileTabs\n                        newFileName={WORKSPACE_FILENAME}\n                        newFileContent={DS_NEW_FILE_CONTENT}\n                        hideFiles={true}\n                    />\n                </Grid>\n            )}\n            <Grid item xs={12}>\n                <BlockEditor editorId={DS_EDITOR_ID} />\n            </Grid>\n            {Flags.diagnostics && <BlockDiagnostics />}\n        </Grid>\n    )\n}\n\nexport default function DSBlockEditor() {\n    const dsls = useMemo(() => {\n        return [dataDsl, chartDsl, fieldsDsl, createIFrameDSL(\"*\")].filter(\n            dsl => !!dsl\n        )\n    }, [])\n\n    return (\n        <NoSsr>\n            <BlockProvider storageKey={DS_SOURCE_STORAGE_KEY} dsls={dsls}>\n                <DSEditorWithContext />\n            </BlockProvider>\n        </NoSsr>\n    )\n}\n","import React from \"react\"\nimport DSBlockEditor from \"../../components/data-science/DSBlockEditor\"\n\nexport default function Page() {\n    return <DSBlockEditor />\n}\n"],"names":["inIFrame","randomDeviceId","workspaceToJSON","setBlockDataWarning","IFrameDomainSpecificLanguage","targetOrigin","id","dslid","blocks","category","pendings","handleMessage","bind","post","action","extras","payload","Math","random","type","window","parent","postMessage","mount","addEventListener","removeEventListener","msg","data","pending","createTransformData","blockWithServices","dataset","Promise","resolve","workspace","blockId","setTimeout","console","warn","undefined","warning","createBlocks","options","debug","bdata","transformData","forEach","block","createCategory","createIFrameDSL","Grid","NoSsr","React","useContext","useMemo","Flags","BlockProvider","BlockDiagnostics","BlockEditor","FileTabs","dataDsl","chartDsl","fieldsDsl","WORKSPACE_FILENAME","FileSystemContext","DS_EDITOR_ID","DS_SOURCE_STORAGE_KEY","DS_NEW_FILE_CONTENT","JSON","stringify","editor","xml","DSEditorWithContext","fileSystem","diagnostics","DSBlockEditor","dsls","filter","dsl","Page"],"sourceRoot":""}