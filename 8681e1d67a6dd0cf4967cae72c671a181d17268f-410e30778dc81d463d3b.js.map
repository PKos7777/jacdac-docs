{"version":3,"sources":["webpack://jacdac-docs/./node_modules/@material-ui/icons/Add.js","webpack://jacdac-docs/./node_modules/@material-ui/icons/Clear.js","webpack://jacdac-docs/./node_modules/@material-ui/icons/Devices.js","webpack://jacdac-docs/./node_modules/@material-ui/icons/PlayArrow.js","webpack://jacdac-docs/./src/components/alert/ConnectAlert.tsx","webpack://jacdac-docs/./src/jacdac/useSelectedNodes.ts","webpack://jacdac-docs/./src/components/dashboard/DashboardDeviceGroup.tsx","webpack://jacdac-docs/./src/components/alert/SimulateDeviceAlert.tsx","webpack://jacdac-docs/./src/components/dashboard/Dashboard.tsx","webpack://jacdac-docs/./src/components/dashboard/DashboardDeviceItem.tsx","webpack://jacdac-docs/./jacdac-ts/src/vm/rolemanager.ts","webpack://jacdac-docs/./jacdac-ts/src/vm/vmrunner.ts","webpack://jacdac-docs/./src/components/vm/VMRunner.tsx"],"names":["useStyles","makeStyles","theme","createStyles","button","marginLeft","spacing","NoSsrConnectAlert","props","classes","serviceClass","useContext","JacdacContext","bus","transports","devices","useChange","b","ignoreSelf","spec","serviceSpecificationFromClassIdentifier","length","name","map","transport","type","ConnectAlert","useSelectedNodes","singleSelection","nodes","useRef","Set","useState","change","setChange","selected","node","current","has","id","setSelected","value","s","delete","clear","add","hasSelection","size","toggleSelected","DeviceGroup","title","action","expanded","toggleExpanded","children","other","handleExpand","device","sectionId","useId","SimulateDeviceAlert","handleStartSimulator","provider","serviceProviderDefinitionFromServiceClass","addServiceProvider","AppContext","toggleShowDeviceHostsDialog","SRV_BUTTON","SRV_BUZZER","SRV_JOYSTICK","SRV_LED","SRV_TRAFFIC_LIGHT","defaultDeviceSort","l","r","srvScore","srv","packets","reduce","prev","pkt","isReading","isValueOrIntensity","score","srvs","ls","services","slice","specification","filter","rs","strcmp","deviceId","defaultDeviceFilter","d","Dashboard","showConnect","showStartSimulators","deviceSort","deviceFilter","useDevices","announced","sort","useMediaQueries","mobile","splitFilter","findServiceProvider","simulators","physicals","roleManager","useRoleManager","handleClearSimulators","serviceProviders","forEach","dev","removeServiceProvider","handleStartSimulators","startSimulators","DashboardDeviceItem","variant","drawerType","breakpoints","breakpointWeight","dashboardServiceWeight","readingRegister","valueRegister","intensityRegister","c","v","DrawerType","xs","sm","md","lg","xl","MyRoleManager","notify","_roles","_devices","on","DEVICE_ANNOUNCE","addServices","DEVICE_DISCONNECT","removeServices","role","Object","keys","find","k","nameMatch","shortName","indexOf","push","service","getService","undefined","n1","n2","cn1","toLowerCase","replace","trim","cn2","getServicesFromName","root","addRoleService","serviceShortName","existingInstance","values","ret","serviceSpecificationFromName","classIdentifier","serviceProvider","JDEventSource","VMStatus","IT4CommandEvaluator","env","gc","checkExpression","e","expr","JDExprEvaluator","lookup","eval","evaluate","_status","Running","args","command","arguments","inst","event","hasEvent","Completed","ev","reg","writeRegister","writeLocal","Stopped","callee","IT4CommandRunner","_eval","reset","status","step","isWaiting","finish","cancel","IT4HandlerRunner","handler","stopped","_commandIndex","_currentCommand","unsubscribe","post_process","commands","Ready","IT4ProgramRunner","program","_waitQueue","_running","_rm","added","_env","serviceChanged","registers","split","registerRegister","events","registerEvent","VMEnvironment","run","_handlers","handlers","h","index","emit","CHANGE","start","roles","refreshEnvironment","nextTime","consumeEvent","VMRunner","factory","useCallback","testRunner","useMemo","t","handleRun","handleCancel","running","disabled"],"mappings":"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","file":"8681e1d67a6dd0cf4967cae72c671a181d17268f-410e30778dc81d463d3b.js","sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _interopRequireWildcard = require(\"@babel/runtime/helpers/interopRequireWildcard\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nvar React = _interopRequireWildcard(require(\"react\"));\n\nvar _createSvgIcon = _interopRequireDefault(require(\"./utils/createSvgIcon\"));\n\nvar _default = (0, _createSvgIcon.default)( /*#__PURE__*/React.createElement(\"path\", {\n  d: \"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z\"\n}), 'Add');\n\nexports.default = _default;","\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _interopRequireWildcard = require(\"@babel/runtime/helpers/interopRequireWildcard\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nvar React = _interopRequireWildcard(require(\"react\"));\n\nvar _createSvgIcon = _interopRequireDefault(require(\"./utils/createSvgIcon\"));\n\nvar _default = (0, _createSvgIcon.default)( /*#__PURE__*/React.createElement(\"path\", {\n  d: \"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z\"\n}), 'Clear');\n\nexports.default = _default;","\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _interopRequireWildcard = require(\"@babel/runtime/helpers/interopRequireWildcard\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nvar React = _interopRequireWildcard(require(\"react\"));\n\nvar _createSvgIcon = _interopRequireDefault(require(\"./utils/createSvgIcon\"));\n\nvar _default = (0, _createSvgIcon.default)( /*#__PURE__*/React.createElement(\"path\", {\n  d: \"M4 6h18V4H4c-1.1 0-2 .9-2 2v11H0v3h14v-3H4V6zm19 2h-6c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h6c.55 0 1-.45 1-1V9c0-.55-.45-1-1-1zm-1 9h-4v-7h4v7z\"\n}), 'Devices');\n\nexports.default = _default;","\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _interopRequireWildcard = require(\"@babel/runtime/helpers/interopRequireWildcard\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nvar React = _interopRequireWildcard(require(\"react\"));\n\nvar _createSvgIcon = _interopRequireDefault(require(\"./utils/createSvgIcon\"));\n\nvar _default = (0, _createSvgIcon.default)( /*#__PURE__*/React.createElement(\"path\", {\n  d: \"M8 5v14l11-7z\"\n}), 'PlayArrow');\n\nexports.default = _default;","// tslint:disable-next-line: no-submodule-imports\nimport { Box, createStyles, makeStyles } from \"@material-ui/core\"\n// tslint:disable-next-line: no-submodule-imports\nimport Alert from \"../ui/Alert\"\nimport React, { useContext } from \"react\"\nimport { serviceSpecificationFromClassIdentifier } from \"../../../jacdac-ts/src/jdom/spec\"\nimport JacdacContext, { JacdacContextProps } from \"../../jacdac/Context\"\nimport ConnectButton from \"../../jacdac/ConnectButton\"\nimport { NoSsr } from \"@material-ui/core\"\nimport useChange from \"../../jacdac/useChange\"\n\nconst useStyles = makeStyles(theme =>\n    createStyles({\n        button: {\n            marginLeft: theme.spacing(2),\n        },\n    })\n)\n\nfunction NoSsrConnectAlert(props: { serviceClass?: number }) {\n    const classes = useStyles()\n    const { serviceClass } = props\n    const { bus } = useContext<JacdacContextProps>(JacdacContext)\n    const { transports } = bus\n    const devices = useChange(bus, b => b.devices({ serviceClass, ignoreSelf: true }))\n    const spec = serviceSpecificationFromClassIdentifier(serviceClass)\n\n    // don't show if no transport, some devices\n    if (!transports.length || devices?.length) return null\n\n    return (\n        <Box displayPrint=\"none\">\n            <Alert severity=\"info\" closeable={true}>\n                {!spec && <span>Did you connect your device?</span>}\n                {spec && <span>Did you connect a {spec.name} device?</span>}\n                {transports.map(transport => (\n                    <ConnectButton\n                        key={transport.type}\n                        transport={transport}\n                        className={classes.button}\n                        full={true}\n                        transparent={true}\n                    />\n                ))}\n            </Alert>\n        </Box>\n    )\n}\n\nexport default function ConnectAlert(props: { serviceClass?: number }) {\n    return (\n        <NoSsr>\n            <NoSsrConnectAlert {...props} />\n        </NoSsr>\n    )\n}\n","import React, { useRef, useState } from \"react\"\nimport { JDNode } from \"../../jacdac-ts/src/jdom/node\"\n\nexport default function useSelectedNodes<TNode extends JDNode>(singleSelection?: boolean) {\n    const nodes = useRef<Set<string>>(new Set<string>())\n    const [change, setChange] = useState(0)\n\n    const selected = (node: TNode) => nodes.current.has(node?.id)\n    const setSelected = (node: TNode, value: boolean) => {\n        if (!node) return;\n        const s = selected(node)\n        if (!!value !== s) {\n            if (!value)\n                nodes.current.delete(node.id)\n            else {\n                if (singleSelection)\n                    nodes.current.clear();\n                nodes.current.add(node.id)\n            }\n            setChange(change + 1)\n        }\n    }\n    return {\n        hasSelection: nodes.current.size > 0,\n        selected,\n        setSelected,\n        toggleSelected: (node: TNode) => {\n            setSelected(node, !selected(node))\n        },\n        clear: () => {\n            nodes.current.clear()\n            setChange(0)\n        }\n    }\n}","import { Grid } from \"@material-ui/core\";\nimport React, { } from \"react\";\nimport { useId } from \"react-use-id-hook\";\nimport { JDDevice } from \"../../../jacdac-ts/src/jdom/device\";\nimport GridHeader from \"../ui/GridHeader\"\nimport { DashboardDeviceProps } from \"./Dashboard\";\nimport DashboardDeviceItem from \"./DashboardDeviceItem\";\n\nexport default function DeviceGroup(props: {\n    title: string,\n    action?: JSX.Element,\n    devices: JDDevice[],\n    expanded?: (device: JDDevice) => boolean,\n    toggleExpanded?: (device: JDDevice) => void,\n    children?: JSX.Element | JSX.Element[]\n} & DashboardDeviceProps) {\n    const { title, action, devices, expanded, toggleExpanded, children, ...other } = props;\n    const handleExpand = (device: JDDevice) => () => toggleExpanded(device)\n    const sectionId = useId()\n\n    if (!action && !devices?.length)\n        return null\n\n    return <section id={sectionId}>\n        <Grid container spacing={1}>\n            <GridHeader title={title} action={action} />\n            {devices?.map(device => <DashboardDeviceItem\n                key={device.id}\n                device={device}\n                expanded={expanded(device)}\n                toggleExpanded={handleExpand(device)}\n                {...other} />)}\n            {children}\n        </Grid>\n    </section>\n}\n","import React, { useContext } from \"react\"\nimport {\n    SRV_BUTTON,\n    SRV_BUZZER,\n    SRV_JOYSTICK,\n    SRV_LED,\n    SRV_TRAFFIC_LIGHT,\n} from \"../../../jacdac-ts/src/jdom/constants\"\nimport {\n    addServiceProvider,\n    serviceProviderDefinitionFromServiceClass,\n} from \"../../../jacdac-ts/src/servers/servers\"\nimport JacdacContext, { JacdacContextProps } from \"../../jacdac/Context\"\nimport AppContext from \"../AppContext\"\nimport Alert from \"../ui/Alert\"\nimport IconButtonWithTooltip from \"../ui/IconButtonWithTooltip\"\nimport AddIcon from \"@material-ui/icons/Add\"\n\nexport default function SimulateDeviceAlert() {\n    const { bus } = useContext<JacdacContextProps>(JacdacContext)\n    const handleStartSimulator = (serviceClass: number) => () => {\n        const provider = serviceProviderDefinitionFromServiceClass(serviceClass)\n        addServiceProvider(bus, provider)\n    }\n    const { toggleShowDeviceHostsDialog } = useContext(AppContext)\n\n    return (\n        <Alert severity=\"info\">\n            Simulate devices (\n            <IconButtonWithTooltip\n                onClick={handleStartSimulator(SRV_BUTTON)}\n                title=\"button\"\n                aria-label=\"start button simulator\"\n            >\n                🔘\n            </IconButtonWithTooltip>\n            ,\n            <IconButtonWithTooltip\n                onClick={handleStartSimulator(SRV_BUZZER)}\n                title=\"buzzer\"\n                aria-label=\"start buzzer simulator\"\n            >\n                🎹\n            </IconButtonWithTooltip>\n            <IconButtonWithTooltip\n                onClick={handleStartSimulator(SRV_JOYSTICK)}\n                title=\"joystick\"\n                aria-label=\"start joystick simulator\"\n            >\n                🕹️\n            </IconButtonWithTooltip>\n            ,\n            <IconButtonWithTooltip\n                onClick={handleStartSimulator(SRV_LED)}\n                title=\"LED\"\n                aria-label=\"start LED simulator\"\n            >\n                💡\n            </IconButtonWithTooltip>\n            ,\n            <IconButtonWithTooltip\n                onClick={handleStartSimulator(SRV_TRAFFIC_LIGHT)}\n                title=\"traffic light\"\n                aria-label=\"start traffic light simulator\"\n            >\n                🚦\n            </IconButtonWithTooltip>\n            , ...) by clicking &nbsp;\n            <IconButtonWithTooltip\n                title=\"start simulator\"\n                onClick={toggleShowDeviceHostsDialog}\n            >\n                <AddIcon />\n            </IconButtonWithTooltip>\n            .\n        </Alert>\n    )\n}\n","import { Grid } from \"@material-ui/core\"\nimport React, { useContext } from \"react\"\nimport { JDDevice } from \"../../../jacdac-ts/src/jdom/device\"\nimport useSelectedNodes from \"../../jacdac/useSelectedNodes\"\nimport { isReading, isValueOrIntensity } from \"../../../jacdac-ts/src/jdom/spec\"\nimport { splitFilter, strcmp } from \"../../../jacdac-ts/src/jdom/utils\"\nimport useDevices from \"../hooks/useDevices\"\nimport JacdacContext, { JacdacContextProps } from \"../../jacdac/Context\"\nimport AppContext from \"../AppContext\"\nimport IconButtonWithTooltip from \"../ui/IconButtonWithTooltip\"\nimport DashboardDeviceGroup from \"./DashboardDeviceGroup\"\nimport AddIcon from \"@material-ui/icons/Add\"\n// tslint:disable-next-line: no-submodule-imports match-default-export-name\nimport ClearIcon from \"@material-ui/icons/Clear\"\n// tslint:disable-next-line: no-submodule-imports match-default-export-name\nimport DevicesIcon from \"@material-ui/icons/Devices\"\nimport ConnectAlert from \"../alert/ConnectAlert\"\nimport ConnectButtons from \"../../jacdac/ConnectButtons\"\nimport useRoleManager from \"../services/useRoleManager\"\nimport useMediaQueries from \"../hooks/useMediaQueries\"\nimport { JDService } from \"../../../jacdac-ts/src/jdom/service\"\nimport SimulateDeviceAlert from \"../alert/SimulateDeviceAlert\"\n\nfunction defaultDeviceSort(l: JDDevice, r: JDDevice): number {\n    const srvScore = (srv: jdspec.ServiceSpec) =>\n        srv.packets.reduce(\n            (prev, pkt) =>\n                prev + (isReading(pkt) ? 10 : isValueOrIntensity(pkt) ? 1 : 0),\n            0\n        ) || 0\n    const score = (srvs: jdspec.ServiceSpec[]) =>\n        srvs.reduce((prev, srv) => srvScore(srv), 0)\n\n    const ls = score(\n        l\n            .services()\n            .slice(1)\n            .map(srv => srv.specification)\n            .filter(spec => !!spec)\n    )\n    const rs = score(\n        r\n            .services()\n            .slice(1)\n            .map(srv => srv.specification)\n            .filter(spec => !!spec)\n    )\n    if (ls !== rs) return -ls + rs\n    return strcmp(l.deviceId, r.deviceId)\n}\n\n// eslint-disable-next-line @typescript-eslint/no-unused-vars\nfunction defaultDeviceFilter(d: JDDevice): boolean {\n    return true\n}\n\nexport interface DashboardDeviceProps {\n    showHeader?: boolean\n    showAvatar?: boolean\n    serviceFilter?: (srv: JDService) => boolean\n}\n\nexport interface DashboardProps extends DashboardDeviceProps {\n    showStartSimulators?: boolean\n    showConnect?: boolean\n    deviceFilter?: (d: JDDevice) => boolean\n    deviceSort?: (l: JDDevice, r: JDDevice) => number\n}\n\nexport default function Dashboard(props: DashboardProps) {\n    const {\n        showConnect,\n        showStartSimulators,\n        deviceSort = defaultDeviceSort,\n        deviceFilter = defaultDeviceFilter,\n        ...other\n    } = props\n    const { bus } = useContext<JacdacContextProps>(JacdacContext)\n    const { toggleShowDeviceHostsDialog } = useContext(AppContext)\n    const devices = useDevices({ announced: true, ignoreSelf: true })\n        .filter(deviceFilter)\n        .sort(deviceSort)\n    const { mobile } = useMediaQueries()\n    const { selected, toggleSelected } = useSelectedNodes(mobile)\n    const [simulators, physicals] = splitFilter(\n        devices,\n        d => !!bus.findServiceProvider(d.deviceId)\n    )\n    const roleManager = useRoleManager()\n    const handleClearSimulators = () => {\n        bus.serviceProviders().forEach(dev => bus.removeServiceProvider(dev))\n    }\n    const handleStartSimulators = () => roleManager?.startSimulators()\n\n    return (\n        <>\n            <DashboardDeviceGroup\n                title=\"Simulators\"\n                action={\n                    <>\n                        {showStartSimulators && !!roleManager && (\n                            <IconButtonWithTooltip\n                                title=\"start missing simulators\"\n                                onClick={handleStartSimulators}\n                            >\n                                <DevicesIcon />\n                            </IconButtonWithTooltip>\n                        )}\n                        <IconButtonWithTooltip\n                            title=\"start simulator\"\n                            onClick={toggleShowDeviceHostsDialog}\n                        >\n                            <AddIcon />\n                        </IconButtonWithTooltip>\n                        <IconButtonWithTooltip\n                            title=\"clear simulators\"\n                            onClick={handleClearSimulators}\n                        >\n                            <ClearIcon />\n                        </IconButtonWithTooltip>{\" \"}\n                    </>\n                }\n                devices={simulators}\n                expanded={selected}\n                toggleExpanded={toggleSelected}\n                {...other}\n            >\n                {showStartSimulators && !simulators?.length && (\n                    <Grid item xs={12}>\n                        <SimulateDeviceAlert />\n                    </Grid>\n                )}\n            </DashboardDeviceGroup>\n            <DashboardDeviceGroup\n                title=\"Devices\"\n                action={\n                    showConnect && (\n                        <ConnectButtons full={false} transparent={true} />\n                    )\n                }\n                devices={physicals}\n                expanded={selected}\n                toggleExpanded={toggleSelected}\n                {...other}\n            >\n                {showConnect && !physicals.length && (\n                    <Grid item xs={12}>\n                        <ConnectAlert />\n                    </Grid>\n                )}\n            </DashboardDeviceGroup>\n        </>\n    )\n}\n","import { Grid } from \"@material-ui/core\";\nimport React, { useContext } from \"react\";\nimport { JDDevice } from \"../../../jacdac-ts/src/jdom/device\";\nimport DashboardDevice from \"./DashboardDevice\";\nimport { GridBreakpoints } from \"../useGridBreakpoints\";\nimport { DashboardDeviceProps } from \"./Dashboard\";\nimport useChange from \"../../jacdac/useChange\";\nimport { dashboardServiceWeight } from \"./DashboardServiceWidget\";\nimport AppContext, { DrawerType } from \"../AppContext\";\n\nexport default function DashboardDeviceItem(props: {\n    device: JDDevice,\n    expanded?: boolean,\n    toggleExpanded?: () => void,\n    variant?: \"icon\" | \"\"\n} & DashboardDeviceProps) {\n    const { device, expanded, toggleExpanded, variant, ...other } = props;\n    const { drawerType } = useContext(AppContext)\n    const breakpoints: GridBreakpoints = useChange(device, () => {\n        const breakpointWeight = device.services()\n            .map(srv => {\n                return dashboardServiceWeight(srv)\n                    || (srv.readingRegister || srv.valueRegister || srv.intensityRegister ? 1 : 0)\n            })\n            .reduce((c: number, v) => c + v, 0);\n\n        if (breakpointWeight > 3 || drawerType !== DrawerType.None)\n            return { xs: 12, sm: 12, md: 12, lg: 6, xl: 6 };\n        else if (breakpointWeight == 3)\n            return { xs: 12, sm: 12, md: 4, lg: 4, xl: 4 };\n        else if (breakpointWeight == 2)\n            return { xs: 12, sm: 6, md: 4, lg: 3, xl: 4 };\n        else\n            return { xs: expanded ? 12 : 6, sm: 4, md: 3, lg: 2, xl: \"auto\" };\n    }, [expanded, drawerType]);\n\n    // based on size, expanded or reduce widget size\n    return <Grid item {...breakpoints}>\n        <DashboardDevice\n            device={device}\n            expanded={expanded}\n            toggleExpanded={toggleExpanded}\n            variant={variant}\n            {...other}\n        />\n    </Grid>\n}","import { JDEventSource } from \"../jdom/eventsource\"\nimport { DEVICE_ANNOUNCE, DEVICE_DISCONNECT } from \"../jdom/constants\"\nimport { JDBus } from \"../jdom/bus\"\nimport { JDDevice } from \"../jdom/device\"\nimport { JDService } from \"../jdom/service\"\nimport { serviceSpecificationFromName } from \"../jdom/spec\"\nimport {\n    addServiceProvider,\n    serviceProviderDefinitionFromServiceClass,\n} from \"../../src/servers/servers\"\nimport { SMap } from \"../jdom/utils\"\n\nexport class MyRoleManager extends JDEventSource {\n    private _roles: SMap<JDService | string> = {}\n    private _devices: JDDevice[] = []\n\n    constructor(\n        private readonly bus: JDBus,\n        private readonly notify: (\n            role: string,\n            service: JDService,\n            added: boolean\n        ) => void\n    ) {\n        super()\n        this.bus.on(DEVICE_ANNOUNCE, (dev: JDDevice) => this.addServices(dev))\n        this.bus.on(DEVICE_DISCONNECT, (dev: JDDevice) =>\n            this.removeServices(dev)\n        )\n    }\n\n    private addServices(dev: JDDevice) {\n        dev.services().forEach(s => {\n            let role = Object.keys(this._roles).find(\n                k =>\n                    typeof this._roles[k] === \"string\" &&\n                    this.nameMatch(\n                        this._roles[k] as string,\n                        s.specification.shortName\n                    )\n            )\n            if (role && this._devices.indexOf(dev) === -1) {\n                this._roles[role] = s\n                this._devices.push(dev)\n                if (this.notify) this.notify(role, s, true)\n            }\n        })\n    }\n\n    private removeServices(dev: JDDevice) {\n        if (this._devices.indexOf(dev) >= 0) {\n            this._devices = this._devices.filter(d => d !== dev)\n            let role = Object.keys(this._roles).find(\n                k =>\n                    typeof this._roles[k] !== \"string\" &&\n                    dev.services().indexOf(this._roles[k] as JDService) >= 0\n            )\n            if (role) {\n                let service = this._roles[role] as JDService\n                this._roles[role] = (this._roles[\n                    role\n                ] as JDService).specification.shortName\n                if (this.notify) this.notify(role, service, false)\n            }\n        }\n    }\n\n    public getService(role: string): JDService {\n        let s = this._roles[role]\n        return !s || typeof s === \"string\" ? undefined : s\n    }\n\n    private nameMatch(n1: string, n2: string) {\n        const cn1 = n1.slice(0).toLowerCase().replace(\"_\", \" \").trim()\n        const cn2 = n2.slice(0).toLowerCase().replace(\"_\", \" \").trim()\n        return cn1 === cn2\n    }\n\n    private getServicesFromName(root: string): JDService[] {\n        return this.bus\n            .services()\n            .filter(s => this.nameMatch(s.specification.shortName, root))\n    }\n\n    public addRoleService(role: string, serviceShortName: string) {\n        const s = this._roles[role]\n        if (s && typeof(s) !== \"string\") \n            return\n        let existingInstance = Object.values(this._roles).find(\n            r =>\n                (typeof r === \"string\" &&\n                    this.nameMatch(r, serviceShortName)) ||\n                (typeof r === \"object\" &&\n                    this.nameMatch(r.specification.shortName, serviceShortName))\n        )\n        this._roles[role] = serviceShortName\n        let ret = this.getServicesFromName(serviceShortName)\n        if (existingInstance || ret.length === 0) {\n            // spin up a new simulator\n            let service = serviceSpecificationFromName(serviceShortName)\n            if (service) {\n                let provider = serviceProviderDefinitionFromServiceClass(\n                    service?.classIdentifier\n                )\n                if (provider) {\n                    let serviceProvider = addServiceProvider(this.bus, provider)\n                }\n            }\n        } else {\n            this._roles[role] = ret[0]\n        }\n    }\n}\n","import { IT4Program, IT4Handler, IT4GuardedCommand } from \"./ir\"\nimport { MyRoleManager } from \"./rolemanager\"\nimport { VMEnvironment } from \"./environment\"\nimport { JDExprEvaluator } from \"./expr\"\nimport { JDBus } from \"../jdom/bus\"\nimport { JDEventSource } from \"../jdom/eventsource\"\nimport { CHANGE } from \"../jdom/constants\"\n\nexport enum VMStatus {\n    Ready,\n    Running,\n    Completed,\n    Stopped,\n}\n\ninterface Environment {\n    lookup: (e: jsep.MemberExpression | string) => any\n    writeRegister: (e: jsep.MemberExpression | string, v: any) => boolean\n    writeLocal: (e: jsep.MemberExpression | string, v: any) => boolean\n    hasEvent: (e: jsep.MemberExpression | string) => boolean\n    refreshEnvironment: () => void\n    unsubscribe: () => void\n}\n\nclass IT4CommandEvaluator {\n    private _status: VMStatus\n    constructor(\n        private readonly env: Environment,\n        private readonly gc: IT4GuardedCommand\n    ) {}\n\n    get status() {\n        return this._status\n    }\n\n    private get inst() {\n        return (this.gc.command.callee as jsep.Identifier).name\n    }\n\n    private checkExpression(e: jsep.Expression) {\n        const expr = new JDExprEvaluator(e => this.env.lookup(e), undefined)\n        return expr.eval(e) ? true : false\n    }\n\n    public evaluate() {\n        // console.log(unparse(this.gc.command))\n        this._status = VMStatus.Running\n        const args = this.gc.command.arguments\n        switch (this.inst) {\n            case \"awaitEvent\": {\n                const event = args[0] as jsep.MemberExpression\n                if (this.env.hasEvent(event)) {\n                    this._status = this.checkExpression(args[1])\n                        ? VMStatus.Completed\n                        : VMStatus.Running\n                }\n                break\n            }\n            case \"awaitCondition\": {\n                this._status = this.checkExpression(args[0])\n                    ? VMStatus.Completed\n                    : VMStatus.Running\n                break\n            }\n            case \"writeRegister\":\n            case \"writeLocal\": {\n                const expr = new JDExprEvaluator(\n                    e => this.env.lookup(e),\n                    undefined\n                )\n                const ev = expr.eval(args[1])\n                const reg = args[0] as jsep.MemberExpression\n                if (\n                    (this.inst === \"writeRegister\" &&\n                        this.env.writeRegister(reg, ev)) ||\n                    (this.inst === \"writeLocal\" && this.env.writeLocal(reg, ev))\n                ) {\n                    this._status = VMStatus.Completed\n                }\n                this._status = VMStatus.Completed\n                break\n            }\n            case \"halt\": {\n                this._status = VMStatus.Stopped\n                break\n            }\n        }\n    }\n}\n\nclass IT4CommandRunner {\n    private _status = VMStatus.Running\n    private _eval: IT4CommandEvaluator\n    constructor(env: Environment, gc: IT4GuardedCommand) {\n        this._eval = new IT4CommandEvaluator(env, gc)\n    }\n\n    get status() {\n        return this._status\n    }\n\n    set status(s: VMStatus) {\n        if (s != this._status) {\n            this._status = s\n        }\n    }\n\n    get isWaiting(): boolean {\n        return this.status === VMStatus.Running\n    }\n\n    reset() {\n        this.status = VMStatus.Running\n    }\n\n    step() {\n        if (this.isWaiting) {\n            this._eval.evaluate()\n            this.finish(this._eval.status)\n        }\n    }\n\n    cancel() {\n        this.finish(VMStatus.Stopped)\n    }\n\n    private finish(s: VMStatus) {\n        if (\n            (this.isWaiting && s === VMStatus.Completed) ||\n            s === VMStatus.Stopped\n        ) {\n            this.status = s\n        }\n    }\n}\n\nclass IT4HandlerRunner {\n    private _commandIndex: number\n    private _currentCommand: IT4CommandRunner\n    private stopped: boolean = false\n\n    constructor(\n        public readonly id: number,\n        public readonly env: Environment,\n        private readonly handler: IT4Handler\n    ) {\n        this.reset()\n    }\n\n    get status() {\n        return this.stopped\n            ? VMStatus.Stopped\n            : this._currentCommand === undefined\n            ? VMStatus.Ready\n            : this._currentCommand.status\n    }\n\n    public reset() {\n        this._commandIndex = undefined\n        this._currentCommand = undefined\n        this.stopped = false\n    }\n\n    cancel() {\n        this.stopped = true\n        this.env.unsubscribe()\n    }\n\n    private post_process() {\n        if (this._currentCommand.status === VMStatus.Stopped)\n            this.stopped = true\n    }\n\n    // run-to-completion semantics\n    step() {\n        if (this.stopped) return\n        if (this._commandIndex === undefined) {\n            this._commandIndex = 0\n            this._currentCommand = new IT4CommandRunner(\n                this.env,\n                this.handler.commands[this._commandIndex]\n            )\n        }\n        this._currentCommand.step()\n        this.post_process()\n        while (\n            this._currentCommand.status === VMStatus.Completed &&\n            this._commandIndex < this.handler.commands.length - 1\n        ) {\n            this._commandIndex++\n            this._currentCommand = new IT4CommandRunner(\n                this.env,\n                this.handler.commands[this._commandIndex]\n            )\n            this._currentCommand.step()\n            this.post_process()\n        }\n    }\n}\n\nexport class IT4ProgramRunner extends JDEventSource {\n    private _handlers: IT4HandlerRunner[]\n    private _env: VMEnvironment\n    private _waitQueue: IT4HandlerRunner[] = []\n    private _running = false\n    private _rm: MyRoleManager\n\n    constructor(private readonly program: IT4Program, bus: JDBus) {\n        super()\n        this._rm = new MyRoleManager(bus, (role, service, added) => {\n            this._env.serviceChanged(role, service, added)\n            if (added) {\n                this.program.registers.forEach(r => {\n                    let [root, reg] = r.split(\".\")\n                    if (root === role) {\n                        this._env.registerRegister(role, reg)\n                    }\n                })\n                this.program.events.forEach(e => {\n                    let [root, ev] = e.split(\".\")\n                    if (root === role) {\n                        this._env.registerEvent(role, ev)\n                    }\n                })\n            }\n        })\n        this._env = new VMEnvironment(() => {\n            this.run()\n        })\n        this._handlers = program.handlers.map(\n            (h, index) => new IT4HandlerRunner(index, this._env, h)\n        )\n        this._waitQueue = this._handlers.slice(0)\n    }\n\n    get status() {\n        const ret =\n            this._running === false\n                ? VMStatus.Stopped\n                : this._waitQueue.length > 0\n                ? VMStatus.Running\n                : VMStatus.Completed\n        return ret\n    }\n\n    cancel() {\n        this._running = false\n        this._waitQueue = this._handlers.slice(0)\n        this._waitQueue.forEach(h => h.reset())\n        this.emit(CHANGE)\n    }\n\n    start() {\n        this.program.roles.forEach(role => {\n            this._rm.addRoleService(role.role, role.serviceShortName)\n        })\n        this._running = true\n        this.emit(CHANGE)\n        this.run()\n    }\n\n    run() {\n        if (!this._running) return\n        this._env.refreshEnvironment()\n        if (this._waitQueue.length > 0) {\n            let nextTime: IT4HandlerRunner[] = []\n            this._waitQueue.forEach(h => {\n                h.step()\n                if (h.status !== VMStatus.Stopped) {\n                    if (h.status === VMStatus.Completed) h.reset()\n                    nextTime.push(h)\n                }\n            })\n            this._waitQueue = nextTime\n            this._env.consumeEvent()\n        } else {\n            this.emit(CHANGE)\n        }\n    }\n}\n","import React, { useCallback, useContext, useMemo } from \"react\"\nimport { Button } from \"@material-ui/core\"\n// tslint:disable-next-line: match-default-export-name no-submodule-imports\nimport { IT4Program } from \"../../../jacdac-ts/src/vm/ir\"\nimport { IT4ProgramRunner, VMStatus } from \"../../../jacdac-ts/src/vm/vmrunner\"\nimport LoadingProgress from \"../ui/LoadingProgress\"\nimport useChange from \"../../jacdac/useChange\"\nimport PlayArrowIcon from \"@material-ui/icons/PlayArrow\"\nimport JacdacContext, { JacdacContextProps } from \"../../jacdac/Context\"\n\nexport default function VMRunner(props: { program: IT4Program }) {\n    const { bus } = useContext<JacdacContextProps>(JacdacContext)\n    const { program } = props\n    const factory = useCallback(\n        bus => program && new IT4ProgramRunner(program, bus),\n        [program]\n    )\n    const testRunner = useMemo(() => factory(bus), [program])\n    const status = useChange(testRunner, t => t?.status)\n    const handleRun = () => testRunner.start()\n    const handleCancel = () => testRunner.cancel()\n    const running = status === VMStatus.Running\n    const disabled = !testRunner\n\n    return (\n        <Button\n            disabled={disabled}\n            variant=\"contained\"\n            onClick={running ? handleCancel : handleRun}\n            color={running ? \"default\" : \"primary\"}\n            startIcon={running ? <LoadingProgress /> : <PlayArrowIcon />}\n        >\n            {running ? \"Stop\" : \"Run\"}\n        </Button>\n    )\n}\n"],"sourceRoot":""}