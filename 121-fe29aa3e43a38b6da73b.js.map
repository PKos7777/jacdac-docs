{"version":3,"sources":["webpack:///./src/components/hooks/useMicrophoneVolume.ts","webpack:///./src/components/widgets/TrendWidget.tsx","webpack:///./src/components/dashboard/DashboardSoundLevel.tsx"],"names":["useMicrophoneVolume","enabled","options","useMicrophoneAnalyzer","analyser","onClickActivateMicrophone","closeMicrophone","frequencies","useRef","Uint8Array","useEffect","volume","a","current","length","frequencyBinCount","getByteFrequencyData","max","bins","n","i","Math","TrendWidget","props","register","min","horizon","size","host","useServiceHost","service","color","useWidgetTheme","background","controlBackground","active","dataRef","undefined","pathRef","dx","m","w","h","dy","subscribe","CHANGE","unpackedValue","v","data","unshift","pop","useAnimationFrame","d","x","y","setAttribute","HostMicrophoneButton","visible","enabledRegister","SoundLevelReg","Enabled","useRegisterBoolValue","useRegisterUnpackedValue","MinDecibels","minDecibels","MaxDecibels","maxDecibels","fftSize","smoothingTimeConstant","title","handleClick","sendSetBoolAsync","REFRESH","reading","setValues","DashboardSoundLevel","soundLevelRegister","SoundLevel","soundLevel","onChange","event","newValue","svalue","sendGetAsync"],"mappings":"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","file":"121-fe29aa3e43a38b6da73b.js","sourcesContent":["import { useEffect, useRef } from \"react\";\nimport { AudioAnalyzerOptions, useMicrophoneAnalyzer } from \"./useAudioAnalyzer\";\n\nexport default function useMicrophoneVolume(enabled: boolean, options?: AudioAnalyzerOptions) {\n    const { analyser, onClickActivateMicrophone, closeMicrophone } = useMicrophoneAnalyzer(options);\n    const frequencies = useRef(new Uint8Array(0));\n\n    useEffect(() => {\n        if (!enabled) closeMicrophone();\n    }, [enabled]);\n\n    return {\n        onClickActivateMicrophone,\n        volume: () => {\n            const a = analyser();\n            if (!a) return 0;\n\n            if (frequencies.current.length !== a.frequencyBinCount)\n                frequencies.current = new Uint8Array(a.frequencyBinCount);\n            a.getByteFrequencyData(frequencies.current);\n            let max = 0;\n            const bins = frequencies.current;\n            const n = bins.length;\n            for (let i = 0; i < n; ++i)\n                max = Math.max(max, bins[i]);\n            return max / 0xff;\n        }\n    }\n}","import React, { useRef, useEffect } from \"react\";\nimport { CHANGE } from \"../../../jacdac-ts/src/jdom/constants\";\nimport { JDRegister } from \"../../../jacdac-ts/src/jdom/register\";\nimport useAnimationFrame from \"../hooks/useAnimationFrame\";\nimport useServiceHost from \"../hooks/useServiceHost\";\nimport SvgWidget from \"./SvgWidget\";\nimport useWidgetTheme from \"./useWidgetTheme\";\n\nexport default function TrendWidget(props: { register: JDRegister, min: number, max: number, horizon: number, size?: string }) {\n    const { register, min, max, horizon, size } = props;\n    const host = useServiceHost(register.service);\n    const color = host ? \"secondary\" : \"primary\";\n    const { background, controlBackground, active } = useWidgetTheme(color)\n    const dataRef = useRef<number[]>(undefined);\n    const pathRef = useRef<SVGPathElement>();\n\n    const dx = 4;\n    const m = 2;\n    const w = horizon * dx + 2 * m;\n    const h = w / 1.612;\n    const dy = (h - 2 * m) / (max - min);\n\n    useEffect(() => {\n        dataRef.current = register ? [] : undefined; // reset data\n        return register?.subscribe(CHANGE, () => {\n            // register new value\n            const [v] = register.unpackedValue as [number];\n            const data = dataRef.current;\n            data.unshift(v);\n            while (data.length > horizon)\n                data.pop();\n\n        })\n    }, [register, horizon, min, max])\n\n    useAnimationFrame(() => {\n        // update dom\n        const data = dataRef.current;\n        if (!data)\n            return false; // nothing to render\n\n        if (pathRef.current) {\n            let d = `M ${w} ${h} `\n            let x = w - m;\n            for (let i = 0; i < data.length; ++i) {\n                const v = data[i];\n                const y = h - m - (v - min) * dy;\n                d += `L ${x} ${y}`\n                x -= dx;\n            }\n            d += ` V ${h} z`\n            pathRef.current.setAttribute(\"d\", d);\n        }\n        return true;\n    }, [dataRef.current])\n\n    return <SvgWidget width={w} height={h} size={size} background={background}>\n        <path fill={active} stroke={controlBackground} strokeWidth={m / 2} ref={pathRef} />\n    </SvgWidget>\n}\n","import React, { useEffect } from \"react\"\nimport { DashboardServiceProps } from \"./DashboardServiceWidget\"\nimport {\n    useRegisterBoolValue,\n    useRegisterUnpackedValue,\n} from \"../../jacdac/useRegisterValue\"\nimport useServiceHost from \"../hooks/useServiceHost\"\nimport { Grid, Slider } from \"@material-ui/core\"\nimport MicIcon from \"@material-ui/icons/Mic\"\nimport { REFRESH, SoundLevelReg } from \"../../../jacdac-ts/src/jdom/constants\"\nimport AnalogSensorServiceHost from \"../../../jacdac-ts/src/hosts/analogsensorservicehost\"\nimport IconButtonWithProgress from \"../ui/IconButtonWithProgress\"\nimport { JDService } from \"../../../jacdac-ts/src/jdom/service\"\nimport useMicrophoneVolume from \"../hooks/useMicrophoneVolume\"\nimport TrendWidget from \"../widgets/TrendWidget\"\nimport LoadingProgress from \"../ui/LoadingProgress\"\n\nfunction HostMicrophoneButton(props: {\n    service: JDService\n    host?: AnalogSensorServiceHost\n    visible: boolean\n}) {\n    const { host, service, visible } = props\n    const enabledRegister = service.register(SoundLevelReg.Enabled)\n    const enabled = useRegisterBoolValue(enabledRegister, props)\n    const [minDecibels] = useRegisterUnpackedValue<[number]>(\n        service.register(SoundLevelReg.MinDecibels),\n        props\n    )\n    const [maxDecibels] = useRegisterUnpackedValue<[number]>(\n        service.register(SoundLevelReg.MaxDecibels),\n        props\n    )\n    const { volume, onClickActivateMicrophone } = useMicrophoneVolume(\n        enabled && !!host,\n        { fftSize: 64, smoothingTimeConstant: 0, minDecibels, maxDecibels }\n    )\n    const title = enabled ? \"Stop microphone\" : \"Start microphone\"\n\n    const handleClick = async () => {\n        if (!enabled) await onClickActivateMicrophone()\n        await enabledRegister.sendSetBoolAsync(!enabled, true)\n    }\n\n    // update volume on demand\n    useEffect(\n        () =>\n            visible &&\n            host?.subscribe(REFRESH, () => {\n                const v = volume?.()\n                if (v !== undefined) {\n                    host.reading.setValues([v])\n                }\n            }),\n        [host, volume, visible]\n    )\n\n    return (\n        <IconButtonWithProgress\n            aria-label={title}\n            title={title}\n            indeterminate={enabled}\n            onClick={handleClick}\n        >\n            <MicIcon />\n        </IconButtonWithProgress>\n    )\n}\n\nexport default function DashboardSoundLevel(props: DashboardServiceProps) {\n    const { visible, service } = props\n    const soundLevelRegister = service.register(SoundLevelReg.SoundLevel)\n    const [soundLevel] = useRegisterUnpackedValue<[number]>(\n        soundLevelRegister,\n        props\n    )\n    const host = useServiceHost<AnalogSensorServiceHost>(service)\n    const color = host ? \"secondary\" : \"primary\"\n\n    const onChange = (event: unknown, newValue: number | number[]): void => {\n        const svalue = newValue as number\n        host?.reading.setValues([svalue])\n        soundLevelRegister.sendGetAsync() // refresh\n    }\n\n    if (soundLevel === undefined) return <LoadingProgress />\n\n    return (\n        <Grid container direction=\"column\">\n            <Grid item>\n                <TrendWidget\n                    register={soundLevelRegister}\n                    min={0}\n                    max={1}\n                    horizon={64}\n                />\n            </Grid>\n            <Grid item>\n                <Grid container spacing={2} alignItems=\"center\">\n                    <Grid item>\n                        <HostMicrophoneButton\n                            service={service}\n                            host={host}\n                            visible={visible}\n                        />\n                    </Grid>\n                    <Grid item xs>\n                        <Slider\n                            disabled={!host}\n                            valueLabelDisplay=\"off\"\n                            min={0}\n                            max={1}\n                            step={0.1}\n                            value={soundLevel}\n                            onChange={onChange}\n                            color={color}\n                        />\n                    </Grid>\n                </Grid>\n            </Grid>\n        </Grid>\n    )\n}\n"],"sourceRoot":""}