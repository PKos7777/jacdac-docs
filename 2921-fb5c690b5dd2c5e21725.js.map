{"version":3,"sources":["webpack://jacdac-docs/./src/components/hooks/useMicrophoneVolume.ts","webpack://jacdac-docs/./src/components/widgets/TrendWidget.tsx","webpack://jacdac-docs/./src/components/dashboard/DashboardSoundLevel.tsx"],"names":["useMicrophoneVolume","enabled","options","useMicrophoneAnalyzer","analyser","onClickActivateMicrophone","closeMicrophone","frequencies","useRef","Uint8Array","useEffect","volume","a","current","length","frequencyBinCount","getByteFrequencyData","max","bins","n","i","Math","TrendWidget","props","register","min","horizon","size","server","useServiceServer","service","color","useWidgetTheme","background","controlBackground","active","dataRef","undefined","pathRef","dx","m","w","h","dy","subscribe","CHANGE","unpackedValue","v","data","unshift","pop","useAnimationFrame","d","x","y","setAttribute","HostMicrophoneButton","visible","enabledRegister","useRegister","SoundLevelReg","minDecibelsRegister","maxDecibelsRegister","useRegisterBoolValue","useRegisterUnpackedValue","minDecibels","maxDecibels","fftSize","smoothingTimeConstant","title","handleClick","sendSetBoolAsync","REFRESH","reading","setValues","DashboardSoundLevel","soundLevelRegister","soundLevel","onChange","event","newValue","svalue","sendGetAsync"],"mappings":"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","file":"2921-fb5c690b5dd2c5e21725.js","sourcesContent":["import { useEffect, useRef } from \"react\";\nimport { AudioAnalyzerOptions, useMicrophoneAnalyzer } from \"./useAudioAnalyzer\";\n\nexport default function useMicrophoneVolume(enabled: boolean, options?: AudioAnalyzerOptions) {\n    const { analyser, onClickActivateMicrophone, closeMicrophone } = useMicrophoneAnalyzer(options);\n    const frequencies = useRef(new Uint8Array(0));\n\n    useEffect(() => {\n        if (!enabled) closeMicrophone();\n    }, [enabled]);\n\n    return {\n        onClickActivateMicrophone,\n        volume: () => {\n            const a = analyser();\n            if (!a) return 0;\n\n            if (frequencies.current.length !== a.frequencyBinCount)\n                frequencies.current = new Uint8Array(a.frequencyBinCount);\n            a.getByteFrequencyData(frequencies.current);\n            let max = 0;\n            const bins = frequencies.current;\n            const n = bins.length;\n            for (let i = 0; i < n; ++i)\n                max = Math.max(max, bins[i]);\n            return max / 0xff;\n        }\n    }\n}","import React, { useRef, useEffect } from \"react\";\nimport { CHANGE } from \"../../../jacdac-ts/src/jdom/constants\";\nimport { JDRegister } from \"../../../jacdac-ts/src/jdom/register\";\nimport useAnimationFrame from \"../hooks/useAnimationFrame\";\nimport useServiceServer from \"../hooks/useServiceServer\";\nimport SvgWidget from \"./SvgWidget\";\nimport useWidgetTheme from \"./useWidgetTheme\";\n\nexport default function TrendWidget(props: { register: JDRegister, min: number, max: number, horizon: number, size?: string }) {\n    const { register, min, max, horizon, size } = props;\n    const server = useServiceServer(register.service);\n    const color = server ? \"secondary\" : \"primary\";\n    const { background, controlBackground, active } = useWidgetTheme(color)\n    const dataRef = useRef<number[]>(undefined);\n    const pathRef = useRef<SVGPathElement>();\n\n    const dx = 4;\n    const m = 2;\n    const w = horizon * dx + 2 * m;\n    const h = w / 1.612;\n    const dy = (h - 2 * m) / (max - min);\n\n    useEffect(() => {\n        dataRef.current = register ? [] : undefined; // reset data\n        return register?.subscribe(CHANGE, () => {\n            // register new value\n            const [v] = register.unpackedValue as [number];\n            const data = dataRef.current;\n            data.unshift(v);\n            while (data.length > horizon)\n                data.pop();\n\n        })\n    }, [register, horizon, min, max])\n\n    useAnimationFrame(() => {\n        // update dom\n        const data = dataRef.current;\n        if (!data)\n            return false; // nothing to render\n\n        if (pathRef.current) {\n            let d = `M ${w} ${h} `\n            let x = w - m;\n            for (let i = 0; i < data.length; ++i) {\n                const v = data[i];\n                const y = h - m - (v - min) * dy;\n                d += `L ${x} ${y}`\n                x -= dx;\n            }\n            d += ` V ${h} z`\n            pathRef.current.setAttribute(\"d\", d);\n        }\n        return true;\n    }, [dataRef.current])\n\n    return <SvgWidget width={w} height={h} size={size} background={background}>\n        <path fill={active} stroke={controlBackground} strokeWidth={m / 2} ref={pathRef} />\n    </SvgWidget>\n}\n","import React, { useEffect } from \"react\"\nimport { DashboardServiceProps } from \"./DashboardServiceWidget\"\nimport {\n    useRegisterBoolValue,\n    useRegisterUnpackedValue,\n} from \"../../jacdac/useRegisterValue\"\nimport useServiceServer from \"../hooks/useServiceServer\"\nimport { Grid, Slider } from \"@material-ui/core\"\nimport MicIcon from \"@material-ui/icons/Mic\"\nimport { REFRESH, SoundLevelReg } from \"../../../jacdac-ts/src/jdom/constants\"\nimport AnalogSensorServer from \"../../../jacdac-ts/src/servers/analogsensorserver\"\nimport IconButtonWithProgress from \"../ui/IconButtonWithProgress\"\nimport { JDService } from \"../../../jacdac-ts/src/jdom/service\"\nimport useMicrophoneVolume from \"../hooks/useMicrophoneVolume\"\nimport TrendWidget from \"../widgets/TrendWidget\"\nimport LoadingProgress from \"../ui/LoadingProgress\"\nimport useRegister from \"../hooks/useRegister\"\n\nfunction HostMicrophoneButton(props: {\n    service: JDService\n    server?: AnalogSensorServer\n    visible: boolean\n}) {\n    const { server, service, visible } = props\n\n    const enabledRegister = useRegister(service, SoundLevelReg.Enabled)\n    const minDecibelsRegister = useRegister(service, SoundLevelReg.MinDecibels)\n    const maxDecibelsRegister = useRegister(service, SoundLevelReg.MaxDecibels)\n\n    const enabled = useRegisterBoolValue(enabledRegister, props)\n    const [minDecibels] = useRegisterUnpackedValue<[number]>(\n        minDecibelsRegister,\n        props\n    )\n    const [maxDecibels] = useRegisterUnpackedValue<[number]>(\n        maxDecibelsRegister,\n        props\n    )\n    const { volume, onClickActivateMicrophone } = useMicrophoneVolume(\n        enabled && !!server,\n        { fftSize: 64, smoothingTimeConstant: 0, minDecibels, maxDecibels }\n    )\n    const title = enabled ? \"Stop microphone\" : \"Start microphone\"\n\n    const handleClick = async () => {\n        if (!enabled && server) await onClickActivateMicrophone()\n        await enabledRegister.sendSetBoolAsync(!enabled, true)\n    }\n\n    // update volume on demand\n    useEffect(\n        () =>\n            visible &&\n            server?.subscribe(REFRESH, () => {\n                const v = volume?.()\n                if (v !== undefined) {\n                    server.reading.setValues([v])\n                }\n            }),\n        [server, volume, visible]\n    )\n\n    return (\n        <IconButtonWithProgress\n            aria-label={title}\n            title={title}\n            indeterminate={enabled}\n            onClick={handleClick}\n        >\n            <MicIcon />\n        </IconButtonWithProgress>\n    )\n}\n\nexport default function DashboardSoundLevel(props: DashboardServiceProps) {\n    const { visible, service } = props\n    const soundLevelRegister = useRegister(service, SoundLevelReg.SoundLevel)\n    const [soundLevel] = useRegisterUnpackedValue<[number]>(\n        soundLevelRegister,\n        props\n    )\n    const server = useServiceServer<AnalogSensorServer>(service)\n    const color = server ? \"secondary\" : \"primary\"\n\n    const onChange = (event: unknown, newValue: number | number[]): void => {\n        const svalue = newValue as number\n        server?.reading.setValues([svalue])\n        soundLevelRegister.sendGetAsync() // refresh\n    }\n\n    if (soundLevel === undefined) return <LoadingProgress />\n\n    return (\n        <Grid container direction=\"column\">\n            <Grid item>\n                <TrendWidget\n                    register={soundLevelRegister}\n                    min={0}\n                    max={1}\n                    horizon={64}\n                />\n            </Grid>\n            <Grid item>\n                <Grid container spacing={2} alignItems=\"center\">\n                    <Grid item>\n                        <HostMicrophoneButton\n                            service={service}\n                            server={server}\n                            visible={visible}\n                        />\n                    </Grid>\n                    <Grid item xs>\n                        <Slider\n                            disabled={!server}\n                            valueLabelDisplay=\"off\"\n                            min={0}\n                            max={1}\n                            step={0.1}\n                            value={soundLevel}\n                            onChange={onChange}\n                            color={color}\n                        />\n                    </Grid>\n                </Grid>\n            </Grid>\n        </Grid>\n    )\n}\n"],"sourceRoot":""}