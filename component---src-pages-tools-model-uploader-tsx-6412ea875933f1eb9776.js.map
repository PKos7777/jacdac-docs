{"version":3,"sources":["webpack:///./jacdac-ts/src/jdom/sensoraggregatorclient.ts","webpack:///./src/components/ServiceList.tsx","webpack:///./src/components/useDb.ts","webpack:///./jacdac-ts/src/jdom/modelrunner.ts","webpack:///./src/components/SensorAggregatorConfigView.tsx","webpack:///./src/components/useCall.tsx","webpack:///./node_modules/@material-ui/icons/esm/Link.js","webpack:///./src/pages/tools/model-uploader.tsx"],"names":["SensorAggregatorClient","service","registersUseAcks","setInputs","cfg","error","mapType","tp","SensorAggregatorSampleType","U8","U16","U32","I8","I16","I32","msg","Error","inputs","totalSampleSize","map","input","deviceId","serviceIndex","serviceClass","specification","serviceSpecificationFromClassIdentifier","toString","freeze","readingReg","packets","find","isReading","sampleType","undefined","sampleSize","sampleShift","fields","field","Math","abs","storage","shift","bufferConcat","fromHex","Uint8Array","jdpack","JD_SERIAL_MAX_PAYLOAD_SIZE","unshift","samplingInterval","samplesInWindow","register","SensorAggregatorReg","Inputs","sendSetAsync","bufferConcatMany","collect","numSamples","StreamingSamples","sendSetPackedAsync","subscribeSample","handler","reg","CurrentSample","mount","subscribe","REPORT_RECEIVE","bufferToArray","data","NumberFormat","Float32LE","getReg","id","f","refresh","stats","info","NumSamples","r","intValue","SampleSize","Object","keys","JDServiceClient","ServiceListItem","props","content","checked","checkedDisabled","toggleChecked","actions","device","handleCheck","ServiceList","selected","toggleSelected","alertMissing","useContext","JacdacContext","bus","services","useChange","n","gridBreakpoints","useGridBreakpoints","length","handleSelected","handleChecked","serviceContent","serviceActions","useDbBlob","DbContext","db","useState","_value","_setValue","values","blobs","useEffect","_mounted","DB_VALUE_CHANGE","changed","get","v","console","log","set","useEffectAsync","mounted","blob","setBlob","useDbUint8Array","blobName","model","setModel","readBlobToUint8Array","buf","useDbString","readBlobToText","t","useDbJSON","value","JSONTryParse","isMLModelSupported","formatRegValue","U","getMLModelFormatName","SRV_MODEL_RUNNER","enums","members","m0","m1","slice","ModelRunnerClient","isModelSupported","ModelRunnerReg","Format","subscribeResults","Outputs","deployModel","onProgress","sendCmdAwaitResponseAsync","Packet","jdpacked","ModelRunnerCmd","SetModel","resp","jdunpack","pipePort","pipe","OutPipe","chunkSize","i","send","close","autoInvoke","everySamples","AutoInvokeEvery","modelStats","ModelSize","AllocatedArenaSize","InputShape","UInt16LE","OutputShape","LastError","SensorAggregatorInputConfigView","serviceName","SensorAggregatorConfigView","config","useCall","AppContext","setAppError","setError","running","setRunning","progress","setProgress","handleProgress","p","call","e","callAsync","alert","ImportButton","lazy","ModelContent","modelSize","useRegisterIntValue","lastError","useRegisterStringValue","prettySize","ModelActions","sensorAggregatorService","sensorInput","modelDisabled","handleDeployModel","aggregator","runner","ModelUploader","importing","setImporting","sensorConfig","setSensorConfig","ServiceManagerContext","modelStore","handleTfmodelFiles","files","file","handleClearModel","handleSensorConfigFiles","handleClearConfiguration","handleLoadModel","loadFile","handleLoadInputConfiguration","models","_","inputConfigurations","byteLength","path","name","size","iconfig","SRV_SENSOR_AGGREGATOR"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AAGA;AACA;AACA;AAoBO,IAAMA,sBAAb;AAAA;;AACI,kCAAYC,OAAZ,EAAgC;AAAA;;AAC5B,wCAAMA,OAAN;AACA,UAAKA,OAAL,CAAaC,gBAAb,GAAgC,IAAhC;AAF4B;AAG/B;;AAJL;;AAAA,SAMUC,SANV;AAAA,8MAMI,iBAAgBC,GAAhB;AAAA;;AAAA,UACaC,KADb,EAIaC,OAJb;AAAA;AAAA;AAAA;AAAA;AAIaA,qBAJb,qBAIqBC,EAJrB,EAIiC;AACzB,wBAAQA,EAAR;AACI,uBAAK,CAAL;AAAQ,2BAAOC,mGAA0B,CAACC,EAAlC;;AACR,uBAAK,CAAL;AAAQ,2BAAOD,mGAA0B,CAACE,GAAlC;;AACR,uBAAK,CAAL;AAAQ,2BAAOF,mGAA0B,CAACG,GAAlC;;AACR,uBAAK,CAAC,CAAN;AAAS,2BAAOH,mGAA0B,CAACI,EAAlC;;AACT,uBAAK,CAAC,CAAN;AAAS,2BAAOJ,mGAA0B,CAACK,GAAlC;;AACT,uBAAK,CAAC,CAAN;AAAS,2BAAOL,mGAA0B,CAACM,GAAlC;;AACT;AACIT,yBAAK,CAAC,sBAAD,CAAL;AARR;AAUH,eAfL;;AACaA,mBADb,mBACmBU,GADnB,EACgC;AACxB,sBAAM,IAAIC,KAAJ,CAAU,wBAAwBD,GAAlC,CAAN;AACH,eAHL;;AAiBI,kBAAI,CAACX,GAAD,IAAQ,CAACA,GAAG,CAACa,MAAjB,EACIZ,KAAK,CAAC,sBAAD,CAAL;AAEAa,6BApBR,GAoB0B,CApB1B;AAqBUD,oBArBV,kBAqBmBb,GAAG,CAACa,MArBvB,gDAqBmB,YAAYE,GAAZ,CAAgB,UAAAC,KAAK,EAAI;AAAA,oBAC5BC,QAD4B,GACaD,KADb,CAC5BC,QAD4B;AAAA,oBAClBC,YADkB,GACaF,KADb,CAClBE,YADkB;AAAA,oBACJC,YADI,GACaH,KADb,CACJG,YADI;AAEpC,oBAAI,CAAC,CAACF,QAAF,KAAe,CAAC,CAACC,YAArB,EACIjB,KAAK,wDAAL;AACJ,oBAAMmB,aAAa,GAAGC,6FAAuC,CAACF,YAAD,CAA7D;AACA,oBAAI,CAACC,aAAL,EACInB,KAAK,2CAAyCkB,YAAY,CAACG,QAAb,CAAsB,EAAtB,CAAzC,CAAL;AACJ,oBAAMC,MAAM,GAAG,CAAC,CAACN,QAAjB;AACA,oBAAMO,UAAU,GAAGJ,aAAa,CAACK,OAAd,CAAsBC,IAAtB,CAA2BC,uDAA3B,CAAnB;AACA,oBAAI,CAACH,UAAL,EACIvB,KAAK,gBAAckB,YAAY,CAACG,QAAb,CAAsB,EAAtB,CAAd,uCAAL;AACJ,oBAAIM,UAAsC,GAAGC,SAA7C;AACA,oBAAIC,UAAU,GAAG,CAAjB;AACA,oBAAIC,WAAW,GAAG,CAAlB;;AACA,qEAAoBP,UAAU,CAACQ,MAA/B,wCAAuC;AAAA,sBAA5BC,KAA4B;AACnCH,4BAAU,IAAII,IAAI,CAACC,GAAL,CAASF,KAAK,CAACG,OAAf,CAAd;;AACA,sBAAIR,UAAU,KAAKC,SAAnB,EAA8B;AAC1BD,8BAAU,GAAG1B,OAAO,CAAC+B,KAAK,CAACG,OAAP,CAApB;AACAL,+BAAW,GAAGE,KAAK,CAACI,KAAN,IAAe,CAA7B;AACH;;AACD,sBAAIT,UAAU,IAAI1B,OAAO,CAAC+B,KAAK,CAACG,OAAP,CAArB,IAAwCL,WAAW,KAAKE,KAAK,CAACI,KAAN,IAAe,CAApB,CAAvD,EACIpC,KAAK,CAAC,0BAAD,CAAL;AACP;;AACDa,+BAAe,IAAIgB,UAAnB;AACA,uBAAOQ,mEAAY,CACff,MAAM,GAAGgB,8DAAO,CAACtB,QAAD,CAAV,GAAuB,IAAIuB,UAAJ,CAAe,CAAf,CADd,EAEfC,4DAAM,CAAC,iBAAD,EAAoB,CACtBtB,YADsB,EAEtBI,MAAM,GAAGL,YAAH,GAAkB,CAFF,EAGtBY,UAHsB,EAItBF,UAJsB,EAKtBG,WALsB,CAApB,CAFS,CAAnB;AAUH,eAlCc,CArBnB;AAyDI,kBAAIjB,eAAe,GAAG4B,8EAAtB,EACIzC,KAAK,CAAC,6BAAD,CAAL,CA1DR,CA4DI;;AACAY,oBAAM,CAAC8B,OAAP,CAAeF,4DAAM,CAAC,aAAD,EAAgB,CAACzC,GAAG,CAAC4C,gBAAL,EAAuB5C,GAAG,CAAC6C,eAA3B,EAA4C,CAA5C,CAAhB,CAArB;AA7DJ;AAAA,qBA8DU,KAAKhD,OAAL,CAAaiD,QAAb,CAAsBC,4FAAmB,CAACC,MAA1C,EACDC,YADC,CACYC,uEAAgB,CAACrC,MAAD,CAD5B,CA9DV;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KANJ;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAAA,SAwEUsC,OAxEV;AAAA,4MAwEI,kBAAcC,UAAd;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBACU,KAAKvD,OAAL,CAAaiD,QAAb,CAAsBC,4FAAmB,CAACM,gBAA1C,EACDC,kBADC,CACkB,KADlB,EACyB,CAACF,UAAD,CADzB,CADV;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAxEJ;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAAA,SA6EIG,eA7EJ,GA6EI,yBAAgBC,OAAhB,EAAiE;AAC7D,QAAMC,GAAG,GAAG,KAAK5D,OAAL,CAAaiD,QAAb,CAAsBC,4FAAmB,CAACW,aAA1C,CAAZ;AACA,WAAO,KAAKC,KAAL,CAAWF,GAAG,CAACG,SAAJ,CAAcC,kEAAd,EACd;AAAA,aAAML,OAAO,CAACM,qEAAa,CAACL,GAAG,CAACM,IAAL,EAAWC,4DAAY,CAACC,SAAxB,CAAd,CAAb;AAAA,KADc,CAAX,CAAP;AAEH,GAjFL;;AAAA,SAmFkBC,MAnFlB;AAAA,2MAmFI,kBAAqBC,EAArB,EAA8CC,CAA9C;AAAA;AAAA;AAAA;AAAA;AAAA;AACUX,iBADV,GACgB,KAAK5D,OAAL,CAAaiD,QAAb,CAAsBqB,EAAtB,CADhB;AAAA;AAAA,qBAEUV,GAAG,CAACY,OAAJ,EAFV;;AAAA;AAAA,gDAGWD,CAAC,CAACX,GAAD,CAHZ;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAnFJ;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAAA,SAyFUa,KAzFV;AAAA,0MAyFI;AAAA;;AAAA;AAAA;AAAA;AAAA;AACI;AACMC,kBAFV,GAEsB;AACd,8BAAc,KAAKL,MAAL,CAAYnB,4FAAmB,CAACyB,UAAhC,EAA4C,UAAAC,CAAC;AAAA,yBAAIA,CAAC,CAACC,QAAN;AAAA,iBAA7C,CADA;AAEd,8BAAc,KAAKR,MAAL,CAAYnB,4FAAmB,CAAC4B,UAAhC,EAA4C,UAAAF,CAAC;AAAA,yBAAIA,CAAC,CAACC,QAAN;AAAA,iBAA7C;AAFA,eAFtB;AAAA,qCAMqBE,MAAM,CAACC,IAAP,CAAYN,IAAZ,CANrB;;AAAA;AAAA;AAAA;AAAA;AAAA;;AAMeJ,gBANf;AAAA;AAAA,qBAOyBI,IAAI,CAACJ,EAAD,CAP7B;;AAAA;AAOQI,kBAAI,CAACJ,EAAD,CAPZ;;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA,gDASWI,IATX;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAzFJ;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAAA;AAAA,EAA4CO,sEAA5C,E;;;;;;;;AC3BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AAEA;AAEA;;AAGA,SAASC,eAAT,CAAyBC,KAAzB,EAOG;AAAA,MACSnF,OADT,GACgFmF,KADhF,CACSnF,OADT;AAAA,MACkBoF,OADlB,GACgFD,KADhF,CACkBC,OADlB;AAAA,MAC2BC,OAD3B,GACgFF,KADhF,CAC2BE,OAD3B;AAAA,MACoCC,eADpC,GACgFH,KADhF,CACoCG,eADpC;AAAA,MACqDC,aADrD,GACgFJ,KADhF,CACqDI,aADrD;AAAA,MACoEC,OADpE,GACgFL,KADhF,CACoEK,OADpE;AAAA,MAESC,MAFT,GAEoBzF,OAFpB,CAESyF,MAFT;;AAIC,MAAMC,WAAW,GAAG,SAAdA,WAAc;AAAA,WAAMH,aAAa,EAAnB;AAAA,GAApB;;AAEA,sBAAO,2DAAC,iEAAD,qBACH,2DAAC,kEAAD;AAAkB,UAAM,EAAEE,MAA1B;AAAkC,aAAS,EAAE;AAA7C,IADG,eAEH,2DAAC,iEAAD,qBACI,2DAAC,+EAAD;AAAiB,UAAM,EAAEA;AAAzB,IADJ,EAEKL,OAFL,CAFG,eAMH,2DAAC,iEAAD,QACKC,OAAO,KAAKrD,SAAZ,iBAAyB,2DAAC,iEAAD;AAAQ,YAAQ,EAAEsD,eAAlB;AAAmC,YAAQ,EAAEI,WAA7C;AAA0D,WAAO,EAAEL;AAAnE,IAD9B,EAEKG,OAFL,CANG,CAAP;AAWH;;AAEc,SAASG,WAAT,CAAqBR,KAArB,EAOZ;AAAA,MACS7D,YADT,GACoF6D,KADpF,CACS7D,YADT;AAAA,MACuBsE,QADvB,GACoFT,KADpF,CACuBS,QADvB;AAAA,MACiCC,cADjC,GACoFV,KADpF,CACiCU,cADjC;AAAA,MACiDT,OADjD,GACoFD,KADpF,CACiDC,OADjD;AAAA,MAC0DI,OAD1D,GACoFL,KADpF,CAC0DK,OAD1D;AAAA,MACmEM,YADnE,GACoFX,KADpF,CACmEW,YADnE;;AAAA,oBAEiBC,wDAAU,CAAqBC,+DAArB,CAF3B;AAAA,MAESC,GAFT,eAESA,GAFT;;AAGC,MAAMC,QAAQ,GAAGC,yEAAS,CAACF,GAAD,EAAM,UAAAG,CAAC;AAAA,WAAIA,CAAC,CAACF,QAAF,CAAW;AAAE5E,kBAAY,EAAZA;AAAF,KAAX,CAAJ;AAAA,GAAP,CAA1B;AACA,MAAM+E,eAAe,GAAGC,2EAAkB,CAACJ,QAAD,aAACA,QAAD,uBAACA,QAAQ,CAAEK,MAAX,CAA1C;;AAEA,MAAMC,cAAc,GAAG,SAAjBA,cAAiB,CAACxG,OAAD;AAAA,WAAwB4F,QAAQ,IAAIA,QAAQ,CAAC5F,OAAD,CAA5C;AAAA,GAAvB;;AACA,MAAMyG,aAAa,GAAG,SAAhBA,aAAgB,CAACzG,OAAD;AAAA,WAAwB;AAAA,aAAM6F,cAAc,IAAIA,cAAc,CAAC7F,OAAD,CAAtC;AAAA,KAAxB;AAAA,GAAtB;;AACA,MAAM0G,cAAc,GAAG,SAAjBA,cAAiB,CAAC1G,OAAD;AAAA,WAAwBoF,OAAO,IAAIA,OAAO,CAACpF,OAAD,CAA1C;AAAA,GAAvB;;AACA,MAAM2G,cAAc,GAAG,SAAjBA,cAAiB,CAAC3G,OAAD;AAAA,WAAwBwF,OAAO,IAAIA,OAAO,CAACxF,OAAD,CAA1C;AAAA,GAAvB;;AAEA,MAAI8F,YAAY,IAAI,EAACI,QAAD,aAACA,QAAD,eAACA,QAAQ,CAAEK,MAAX,CAApB,EACI,oBAAO,2DAAC,0DAAD;AAAO,YAAQ,EAAC;AAAhB,KAAwBT,YAAxB,CAAP;AAEJ,sBAAQ,2DAAC,iEAAD;AAAK,MAAE,EAAE;AAAT,kBACJ,2DAAC,iEAAD;AAAM,aAAS,MAAf;AAAgB,WAAO,EAAE;AAAzB,KACKI,QADL,aACKA,QADL,uBACKA,QAAQ,CAAEhF,GAAV,CAAc,UAAAlB,OAAO;AAAA,wBAAI,2DAAC,iEAAD;AAAM,SAAG,EAAEA,OAAO,CAACsE,EAAnB;AAAuB,UAAI;AAA3B,OAAgC+B,eAAhC,gBACtB,2DAAC,eAAD;AACI,aAAO,EAAErG,OADb;AAEI,aAAO,EAAEwG,cAAc,CAACxG,OAAD,CAF3B;AAGI,mBAAa,EAAEyG,aAAa,CAACzG,OAAD,CAHhC;AAII,aAAO,EAAE0G,cAAc,CAAC1G,OAAD,CAJ3B;AAKI,aAAO,EAAE2G,cAAc,CAAC3G,OAAD;AAL3B,MADsB,CAAJ;AAAA,GAArB,CADL,CADI,CAAR;AAaH,C;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC1ED;AACA;AACA;AACA;AAEO,SAAS4G,SAAT,CAAmBtC,EAAnB,EAA+B;AAAA,oBACnByB,2BAAU,CAACc,4BAAD,CADS;AAAA,MAC1BC,EAD0B,eAC1BA,EAD0B;;AAAA,kBAENC,yBAAQ,CAAO/E,SAAP,CAFF;AAAA,MAE3BgF,MAF2B;AAAA,MAEnBC,SAFmB;;AAGlC,MAAMC,MAAM,GAAGJ,EAAH,aAAGA,EAAH,uBAAGA,EAAE,CAAEK,KAAnB,CAHkC,CAKlC;;AACAC,4BAAS,CAAC,YAAM;AACZ,QAAIC,QAAQ,GAAG,IAAf;AACA,WAAOH,MAAP,aAAOA,MAAP,uBAAOA,MAAM,CAAEnD,SAAR,CAAkBuD,oCAAlB;AAAA,sGAAmC,iBAAOC,OAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,sBAClCA,OAAO,KAAKjD,EADsB;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA,uBAGd4C,MAAM,CAACM,GAAP,CAAWlD,EAAX,CAHc;;AAAA;AAGxBmD,iBAHwB;;AAI9B,oBAAIJ,QAAJ,EAAc;AACVJ,2BAAS,CAACQ,CAAD,CAAT;AACH;;AAN6B;AAAA;;AAAA;AAAA;AAAA;AAS9BC,uBAAO,CAACC,GAAR;AAT8B;AAAA,uBAUxBT,MAVwB,aAUxBA,MAVwB,uBAUxBA,MAAM,CAAEU,GAAR,CAAYtD,EAAZ,EAAgBtC,SAAhB,CAVwB;;AAAA;AAAA,iDAa/B,YAAM;AACTqF,0BAAQ,GAAG,KAAX;AACH,iBAfqC;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAAnC;;AAAA;AAAA;AAAA;AAAA,QAAP;AAiBH,GAnBQ,EAmBN,CAACH,MAAD,CAnBM,CAAT,CANkC,CA2BlC;;AACAW,2CAAc;AAAA,qGAAC,kBAAOC,OAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBAESZ,MAFT,aAESA,MAFT,uBAESA,MAAM,CAAEM,GAAR,CAAYlD,EAAZ,CAFT;;AAAA;AAEDmD,eAFC;AAGP,kBAAIK,OAAO,EAAX,EACIb,SAAS,CAACQ,CAAD,CAAT;AAJG;AAAA;;AAAA;AAAA;AAAA;AAMPC,qBAAO,CAACC,GAAR,eANO,CAOP;;AAPO;AAAA,qBAQDT,MARC,aAQDA,MARC,uBAQDA,MAAM,CAAEU,GAAR,CAAYtD,EAAZ,EAAgBtC,SAAhB,CARC;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAD;;AAAA;AAAA;AAAA;AAAA,OAUX,CAACkF,MAAD,CAVW,CAAd;AAYA,SAAO;AACHa,QAAI,EAAEf,MADH;AAEHgB,WAAO;AAAA,0GAAE,kBAAOD,IAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBACCb,MADD,aACCA,MADD,uBACCA,MAAM,CAAEU,GAAR,CAAYtD,EAAZ,EAAgByD,IAAhB,CADD;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAAF;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAFJ,GAAP;AAMH;AAEM,SAASE,eAAT,CAAyBC,QAAzB,EAA2C;AAAA,mBACpBtB,SAAS,CAACsB,QAAD,CADW;AAAA,MACtCH,IADsC,cACtCA,IADsC;AAAA,MAChCC,OADgC,cAChCA,OADgC;;AAAA,mBAEpBjB,yBAAQ,CAAa/E,SAAb,CAFY;AAAA,MAEvCmG,KAFuC;AAAA,MAEhCC,QAFgC;;AAI9CP,2CAAc;AAAA,qGAAC,kBAAOC,OAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBACNC,IADM;AAAA;AAAA;AAAA;;AAEPK,sBAAQ,CAACpG,SAAD,CAAR;AAFO;AAAA;;AAAA;AAAA;AAAA,qBAKWqG,6CAAoB,CAACN,IAAD,CAL/B;;AAAA;AAKDO,iBALC;AAMP,kBAAIR,OAAO,EAAX,EACIM,QAAQ,CAACE,GAAD,CAAR;;AAPG;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAD;;AAAA;AAAA;AAAA;AAAA,OASX,CAACP,IAAD,CATW,CAAd;AAWA,SAAO;AACH7D,QAAI,EAAEiE,KADH;AAEHH,WAAO,EAAPA;AAFG,GAAP;AAIH;AAEM,SAASO,WAAT,CAAqBL,QAArB,EAAuC;AAAA,oBAChBtB,SAAS,CAACsB,QAAD,CADO;AAAA,MAClCH,IADkC,eAClCA,IADkC;AAAA,MAC5BC,OAD4B,eAC5BA,OAD4B;;AAAA,mBAEhBjB,yBAAQ,CAAS/E,SAAT,CAFQ;AAAA,MAEnCmG,KAFmC;AAAA,MAE5BC,QAF4B;;AAI1CP,2CAAc,oGAAC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gBACNE,IADM;AAAA;AAAA;AAAA;;AAEPK,oBAAQ,CAACpG,SAAD,CAAR;AAFO;AAAA;;AAAA;AAAA;AAAA,mBAKSwG,uCAAc,CAACT,IAAD,CALvB;;AAAA;AAKDU,aALC;AAMPL,oBAAQ,CAACK,CAAD,CAAR;;AANO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAD,IAQX,CAACV,IAAD,CARW,CAAd;AAUA,SAAO;AACH7D,QAAI,EAAEiE,KADH;AAEHH,WAAO,EAAPA;AAFG,GAAP;AAIH;AAEM,SAASU,SAAT,CAAsBR,QAAtB,EAAwC;AAAA,qBACjBK,WAAW,CAACL,QAAD,CADM;AAAA,MACnChE,IADmC,gBACnCA,IADmC;AAAA,MAC7B8D,SAD6B,gBAC7BA,OAD6B;;AAE3C,MAAMW,KAAQ,GAAGC,qCAAY,CAAC1E,IAAD,CAA7B;AACA,SAAO;AACHyE,SAAK,EAALA,KADG;AAEHX,WAAO;AAAA,2GAAE,kBAAOD,IAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBACCC,SAAO,CAACD,IAAD,CADR;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAAF;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAFJ,GAAP;AAMH,C;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACvGD;AACA;AACA;AAKA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEO,SAASc,kBAAT,CAA4BV,KAA5B,EAA+CW,cAA/C,EAAuE;AAC1E,SAAOC,uBAAA,CAASZ,KAAT,EAAgB,CAAhB,KAAsBW,cAAtB,IAAwCC,uBAAA,CAASZ,KAAT,EAAgB,CAAhB,KAAsBW,cAArE;AACH;AAEM,SAASE,oBAAT,CAA8Bb,KAA9B,EAAiD;AACpD,MAAMjH,GAAG,GAAGM,+DAAuC,CAACyH,sCAAD,CAAvC,CAA0DC,KAA1D,CAAgE,aAAhE,EAA+EC,OAA3F;AACA,MAAMC,EAAE,GAAGL,uBAAA,CAASZ,KAAT,EAAgB,CAAhB,CAAX;AACA,MAAMkB,EAAE,GAAGN,uBAAA,CAASZ,KAAT,EAAgB,CAAhB,CAAX;;AACA,kCAAgBpD,MAAM,CAACC,IAAP,CAAY9D,GAAZ,CAAhB,kCAAkC;AAA7B,QAAMuG,EAAC,mBAAP;AACD,QAAIvG,GAAG,CAACuG,EAAD,CAAH,IAAU2B,EAAV,IAAgBlI,GAAG,CAACuG,EAAD,CAAH,IAAU4B,EAA9B,EACI,OAAO5B,EAAP;AACP;;AACD,SAAO,OAAOsB,sBAAA,CAAQZ,KAAK,CAACmB,KAAN,CAAY,CAAZ,EAAe,CAAf,CAAR,CAAd;AACH;AAEM,IAAMC,6BAAb;AAAA;;AACI,6BAAYvJ,OAAZ,EAAgC;AAAA;;AAC5B,wCAAMA,OAAN;AACA,UAAKA,OAAL,CAAaC,gBAAb,GAAgC,IAAhC;AAF4B;AAG/B,GAJL,CAMI;;;AANJ;;AAAA,SAOUuJ,gBAPV;AAAA;AAAA;AAAA,iHAOI,iBAAuBrB,KAAvB;AAAA;AAAA;AAAA;AAAA;AAAA;AACUvE,iBADV,GACgB,KAAK5D,OAAL,CAAaiD,QAAb,CAAsBwG,oCAAc,CAACC,MAArC,CADhB;AAAA;AAAA,qBAEU9F,GAAG,CAACY,OAAJ,EAFV;;AAAA;AAAA,+CAGWZ,GAAG,CAACM,IAAJ,IAAY,IAAZ,IAAoB2E,kBAAkB,CAACV,KAAD,EAAQvE,GAAG,CAACiB,QAAJ,KAAiB,CAAzB,CAHjD;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAPJ;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAAA,SAaI8E,gBAbJ,GAaI,0BAAiBhG,OAAjB,EAAkE;AAC9D,QAAMC,GAAG,GAAG,KAAK5D,OAAL,CAAaiD,QAAb,CAAsBwG,oCAAc,CAACG,OAArC,CAAZ;AACA,WAAOhG,GAAG,CAACG,SAAJ,CAAcC,oCAAd,EAA8B,YAAM;AACvCL,aAAO,CAACM,uCAAa,CAACL,GAAG,CAACM,IAAL,EAAWC,8BAAY,CAACC,SAAxB,CAAd,CAAP;AACH,KAFM,CAAP;AAGH,GAlBL;;AAAA,SAoBUyF,WApBV;AAAA,4GAoBI,kBAAkB1B,KAAlB,EAAqC2B,UAArC;AAAA;;AAAA;AAAA;AAAA;AAAA;AACIA,wBAAU,SAAV,IAAAA,UAAU,WAAV,YAAAA,UAAU,CAAG,CAAH,CAAV;AADJ;AAAA,qBAEuB,KAAK9J,OAAL,CAAa+J,yBAAb,CAAuCC,yBAAM,CAACC,QAAP,CAAgBC,oCAAc,CAACC,QAA/B,EAAyC,KAAzC,EAAgD,CAAChC,KAAK,CAAC5B,MAAP,CAAhD,CAAvC,EAAwG,IAAxG,CAFvB;;AAAA;AAEU6D,kBAFV;AAGIN,wBAAU,SAAV,IAAAA,UAAU,WAAV,YAAAA,UAAU,CAAG,IAAH,CAAV;AAHJ,0BAIuBO,gCAAQ,CAAWD,IAAI,CAAClG,IAAhB,EAAsB,KAAtB,CAJ/B,EAIWoG,QAJX;;AAAA,kBAKSA,QALT;AAAA;AAAA;AAAA;;AAAA,oBAMc,IAAIvJ,KAAJ,CAAU,gBAAgBuJ,QAA1B,CANd;;AAAA;AAOUC,kBAPV,GAOiB,IAAIC,wBAAJ,CAAY,KAAKxK,OAAL,CAAayF,MAAzB,EAAiC6E,QAAjC,CAPjB;AAQUG,uBARV,GAQsB,GARtB,EAQ0B;;AACbC,eATb,GASiB,CATjB;;AAAA;AAAA,oBASoBA,CAAC,GAAGvC,KAAK,CAAC5B,MAT9B;AAAA;AAAA;AAAA;;AAAA;AAAA,qBAUcgE,IAAI,CAACI,IAAL,CAAUxC,KAAK,CAACmB,KAAN,CAAYoB,CAAZ,EAAeA,CAAC,GAAGD,SAAnB,CAAV,CAVd;;AAAA;AAWQX,wBAAU,SAAV,IAAAA,UAAU,WAAV,YAAAA,UAAU,CAAG,OAAQY,CAAC,GAAGvC,KAAK,CAAC5B,MAAX,GAAqB,GAA/B,CAAV;;AAXR;AASsCmE,eAAC,IAAID,SAT3C;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA,qBAccF,IAAI,CAACK,KAAL,EAdd;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAkBId,wBAAU,SAAV,IAAAA,UAAU,WAAV,YAAAA,UAAU,CAAG,CAAH,CAAV;;AAlBJ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KApBJ;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAAA,SAyCUe,UAzCV;AAAA,2GAyCI,kBAAiBC,YAAjB;AAAA;AAAA;AAAA;AAAA;AAAA,kBAAiBA,YAAjB;AAAiBA,4BAAjB,GAAgC,CAAhC;AAAA;;AAAA;AAAA,qBACU,KAAK9K,OAAL,CAAaiD,QAAb,CAAsBwG,oCAAc,CAACsB,eAArC,EAAsDtH,kBAAtD,CAAyE,KAAzE,EAAgF,CAACqH,YAAD,CAAhF,CADV;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAzCJ;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAAA,SA6CkBzG,MA7ClB;AAAA,uGA6CI,kBAAqBC,EAArB,EAAyCC,CAAzC;AAAA;AAAA;AAAA;AAAA;AAAA;AACUX,iBADV,GACgB,KAAK5D,OAAL,CAAaiD,QAAb,CAAsBqB,EAAtB,CADhB;AAAA;AAAA,qBAEUV,GAAG,CAACY,OAAJ,EAFV;;AAAA;AAAA,gDAGWD,CAAC,CAACX,GAAD,CAHZ;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KA7CJ;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAAA,SAmDUoH,UAnDV;AAAA,2GAmDI;AAAA;;AAAA;AAAA;AAAA;AAAA;AACUtG,kBADV,GACsB;AACd,6BAAa,KAAKL,MAAL,CAAYoF,oCAAc,CAACwB,SAA3B,EAAsC,UAAArG,CAAC;AAAA,yBAAIA,CAAC,CAACC,QAAN;AAAA,iBAAvC,CADC;AAEd,6BAAa,KAAKR,MAAL,CAAYoF,oCAAc,CAACyB,kBAA3B,EAA+C,UAAAtG,CAAC;AAAA,yBAAIA,CAAC,CAACC,QAAN;AAAA,iBAAhD,CAFC;AAGd,8BAAc,KAAKR,MAAL,CAAYoF,oCAAc,CAAC0B,UAA3B,EAAuC,UAAAvG,CAAC;AAAA,yBAAIX,uCAAa,CAACW,CAAC,CAACV,IAAH,EAASC,8BAAY,CAACiH,QAAtB,CAAjB;AAAA,iBAAxC,CAHA;AAId,+BAAe,KAAK/G,MAAL,CAAYoF,oCAAc,CAAC4B,WAA3B,EAAwC,UAAAzG,CAAC;AAAA,yBAAIX,uCAAa,CAACW,CAAC,CAACV,IAAH,EAASC,8BAAY,CAACiH,QAAtB,CAAjB;AAAA,iBAAzC,CAJD;AAKd,6BAAa,KAAK/G,MAAL,CAAYoF,oCAAc,CAAC6B,SAA3B,EAAsC,UAAA1G,CAAC;AAAA,yBAAImE,mCAAA,CAAqBnE,CAAC,CAACV,IAAvB,CAAJ;AAAA,iBAAvC;AALC,eADtB;AAAA,uCAQqBa,MAAM,CAACC,IAAP,CAAYN,IAAZ,CARrB;;AAAA;AAAA;AAAA;AAAA;AAAA;;AAQeJ,gBARf;AAAA;AAAA,qBASyBI,IAAI,CAACJ,EAAD,CAT7B;;AAAA;AASQI,kBAAI,CAACJ,EAAD,CATZ;;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA,gDAWWI,IAXX;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAnDJ;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAAA;AAAA,EAAuCO,wCAAvC;AA0EA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,E;;;;;;;;;;;;;;;;;;;;;;;ACvLA;AACA;AACA;AAEA;AACA;;AAEA,SAASsG,+BAAT,CAAyCpG,KAAzC,EAAwF;AAAA,oBACpEY,2BAAU,CAAqBC,0BAArB,CAD0D;AAAA,MAC5EC,GAD4E,eAC5EA,GAD4E;;AAAA,MAE5E9E,KAF4E,GAElEgE,KAFkE,CAE5EhE,KAF4E;AAAA,MAG5EG,YAH4E,GAGnCH,KAHmC,CAG5EG,YAH4E;AAAA,MAG9DF,QAH8D,GAGnCD,KAHmC,CAG9DC,QAH8D;AAAA,MAGpDC,YAHoD,GAGnCF,KAHmC,CAGpDE,YAHoD;AAKpF,MAAMoE,MAAM,GAAGrE,QAAQ,IAAI6E,GAAG,CAACR,MAAJ,CAAWrE,QAAX,CAA3B;AAEA,sBAAO,8DACFoK,qCAAW,CAAClK,YAAD,CADT,EAEFmE,MAAM,iBAAI,8BAAC,6BAAD;AAAY,UAAM,EAAEA,MAApB;AAA4B,gBAAY,EAAEpE;AAA1C,IAFR,EAGF,CAACoE,MAAD,IAAWrE,QAAX,iBAAuB,4CAAOA,QAAP,OAAkBC,YAAlB,MAHrB,EAIF,CAACD,QAAD,iBAAa,2DAJX,CAAP;AAMH;;AAEc,SAASqK,0BAAT,CAAoCtG,KAApC,EAA+E;AAAA,MAClFuG,MADkF,GACvEvG,KADuE,CAClFuG,MADkF;AAG1F,MAAI,EAACA,MAAD,aAACA,MAAD,eAACA,MAAM,CAAE1K,MAAT,CAAJ,EACI,oBAAO,6DAAP;AAEJ,sBAAO,8BAAC,wBAAD,qBACH,uDACI,kFAA2B,4CAAO0K,MAAM,CAAC3I,gBAAd,CAA3B,CADJ,eAEI,uFAAgC,4CAAO2I,MAAM,CAAC1I,eAAd,CAAhC,CAFJ,eAGI,sDAAa0I,MAAM,CAAC1K,MAAP,CAAcuF,MAA3B,oBACI,0CACKmF,MAAM,CAAC1K,MAAP,CAAcE,GAAd,CAAkB,UAACC,KAAD,EAAQuJ,CAAR;AAAA,wBAAc;AAAI,SAAG,EAAE,UAAUA;AAAnB,oBAAsB,8BAAC,+BAAD;AAAiC,WAAK,EAAEvJ;AAAxC,MAAtB,CAAd;AAAA,GAAlB,CADL,CADJ,CAHJ,CADG,CAAP;AAWH,C;;;;;;;;;;;;;;;;;;;ACvCD;AACA;AACA;AAIe,SAASwK,OAAT,GAAmB;AAAA,oBACI5F,2BAAU,CAAC6F,6BAAD,CADd;AAAA,MACZC,WADY,eACtBC,QADsB;;AAAA,kBAEJ/E,yBAAQ,EAFJ;AAAA,MAEvB3G,KAFuB;AAAA,MAEhB0L,QAFgB;;AAAA,mBAGA/E,yBAAQ,CAAC,KAAD,CAHR;AAAA,MAGvBgF,OAHuB;AAAA,MAGdC,UAHc;;AAAA,mBAIEjF,yBAAQ,CAAC,CAAD,CAJV;AAAA,MAIvBkF,QAJuB;AAAA,MAIbC,WAJa;;AAM9B,MAAMC,cAAc,GAAG,SAAjBA,cAAiB,CAACC,CAAD;AAAA,WAAeF,WAAW,CAACE,CAAD,CAA1B;AAAA,GAAvB;;AAEA,MAAMC,IAAI,GAAG,SAAPA,IAAO,CAAC1I,OAAD,EAAqD;AAC9D,QAAI;AACAqI,gBAAU,CAAC,IAAD,CAAV;AACAF,cAAQ,CAAC9J,SAAD,CAAR;AACA2B,aAAO,CAACwI,cAAD,CAAP;AACH,KAJD,CAIE,OAAOG,CAAP,EAAU;AACRR,cAAQ,CAACQ,CAAD,CAAR;AACAT,iBAAW,CAACS,CAAD,CAAX;AACH,KAPD,SAQQ;AACJN,gBAAU,CAAC,KAAD,CAAV;AACH;AACJ,GAZD;;AAaA,MAAMO,SAAS;AAAA,oGAAG,iBAAO5I,OAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAEVqI,wBAAU,CAAC,IAAD,CAAV;AACAF,sBAAQ,CAAC9J,SAAD,CAAR;AAHU;AAAA,qBAIJ2B,OAAO,CAACwI,cAAD,CAJH;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAMVL,sBAAQ,aAAR;AACAD,yBAAW,aAAX;;AAPU;AAAA;AAUVG,wBAAU,CAAC,KAAD,CAAV;AAVU;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAH;;AAAA,oBAATO,SAAS;AAAA;AAAA;AAAA,KAAf;;AAaA,MAAMC,KAAK,GAAGpM,KAAK,iBAAI,8BAAC,wBAAD;AAAO,YAAQ,EAAC;AAAhB,KAAyBA,KAAzB,CAAvB;AAEA,SAAO;AACH2L,WAAO,EAAPA,OADG;AAEH3L,SAAK,EAALA,KAFG;AAGH6L,YAAQ,EAARA,QAHG;AAIHO,SAAK,EAALA,KAJG;AAKHH,QAAI,EAAJA,IALG;AAMHE,aAAS,EAATA;AANG,GAAP;AAQH,C;;;;;;;;AClD8B;AACmB;AACnC,iFAAa,eAAe,sBAAmB;AAC9D;AACA,CAAC,UAAU,E;;;;ACJX;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA;AACA;AACA,IAAME,YAAY,gBAAGC,qBAAI,CAAC;AAAA,SAAM,4HAAN;AAAA,CAAD,CAAzB;AAEO,SAASC,YAAT,CAAsBxH,KAAtB,EAAqD;AAAA,MAChDnF,OADgD,GACpCmF,KADoC,CAChDnF,OADgD;AAExD,MAAM4M,SAAS,GAAGC,uDAAmB,CAAC7M,OAAO,CAACiD,QAAR,CAAiBwG,oCAAc,CAACwB,SAAhC,CAAD,CAArC;AACA,MAAM6B,SAAS,GAAGC,0DAAsB,CAAC/M,OAAO,CAACiD,QAAR,CAAiBwG,oCAAc,CAAC6B,SAAhC,CAAD,CAAxC;AAEA,sBAAO,8DACFwB,SAAS,iBAAI,8BAAC,wBAAD;AAAO,YAAQ,EAAC;AAAhB,KAA2BA,SAA3B,CADX,eAEH,8BAAC,6BAAD,wBAAyBF,SAAS,KAAK5K,SAAd,GAA0B,KAA1B,GAAkCgL,oCAAU,CAACJ,SAAD,CAArE,CAFG,eAGH,8BAAC,gCAAD;AAAe,YAAQ,EAAE5M,OAAO,CAACiD,QAAR,CAAiBwG,oCAAc,CAACsB,eAAhC;AAAzB,IAHG,eAIH,8BAAC,gCAAD;AAAe,YAAQ,MAAvB;AAAwB,YAAQ,EAAE/K,OAAO,CAACiD,QAAR,CAAiBwG,oCAAc,CAACG,OAAhC,CAAlC;AAA4E,QAAI,EAAE;AAAlF,IAJG,CAAP;AAMH;AAEM,SAASqD,YAAT,CAAsB9H,KAAtB,EAKJ;AAAA,MACSnF,OADT,GACkEmF,KADlE,CACSnF,OADT;AAAA,MACkBmI,KADlB,GACkEhD,KADlE,CACkBgD,KADlB;AAAA,MACyB+E,uBADzB,GACkE/H,KADlE,CACyB+H,uBADzB;AAAA,MACkDC,WADlD,GACkEhI,KADlE,CACkDgI,WADlD;;AAAA,iBAEiDxB,OAAO,EAFxD;AAAA,MAESI,OAFT,YAESA,OAFT;AAAA,MAEkBE,QAFlB,YAEkBA,QAFlB;AAAA,MAE4BO,KAF5B,YAE4BA,KAF5B;AAAA,MAEmCD,SAFnC,YAEmCA,SAFnC;;AAIC,MAAMa,aAAa,GAAG,CAACpN,OAAD,IAAY,CAACmI,KAAb,IAAsB4D,OAA5C;;AAEA,MAAMsB,iBAAiB;AAAA,oGAAG;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBAAkBd,SAAS;AAAA,iHAAC,iBAAOL,WAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gCAC9CgB,uBAAuB,IAAIC,WADmB;AAAA;AAAA;AAAA;;AAExCG,oCAFwC,GAE3B,IAAIvN,wDAAJ,CAA2BmN,uBAA3B,CAF2B;AAAA;AAAA,iCAGxCI,UAAU,CAACpN,SAAX,CAAqBiN,WAArB,CAHwC;;AAAA;AAAA,gCAK9CnN,OAAO,IAAImI,KALmC;AAAA;AAAA;AAAA;;AAMxCoF,gCANwC,GAM/B,IAAIhE,6BAAJ,CAAsBvJ,OAAtB,CAN+B;AAAA;AAAA,iCAOxCuN,MAAM,CAAC1D,WAAP,CAAmB1B,KAAnB,EAA0B+D,WAA1B,CAPwC;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iBAAD;;AAAA;AAAA;AAAA;AAAA,kBAA3B;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAH;;AAAA,oBAAjBmB,iBAAiB;AAAA;AAAA;AAAA,KAAvB;;AAWA,sBAAO,8DACF,CAACtB,OAAD,iBAAY,8BAAC,kCAAD;AAAQ,YAAQ,EAAEqB,aAAlB;AAAiC,WAAO,EAAC,WAAzC;AAAqD,SAAK,EAAC,SAA3D;AAAqE,WAAO,EAAEC;AAA9E,KACRF,WAAW,GAAG,gCAAH,GAAsC,cADzC,CADV,EAIFpB,OAAO,iBAAI,8BAAC,4CAAD;AAA2B,SAAK,EAAEE,QAAQ,GAAG;AAA7C,IAJT,EAKFO,KALE,CAAP;AAOH;AAEc,SAASgB,aAAT,GAAyB;AAAA,kBACFzG,yBAAQ,CAAC,KAAD,CADN;AAAA,MAC7B0G,SAD6B;AAAA,MAClBC,YADkB;;AAAA,yBAEOzF,eAAe,CAAC,cAAD,CAFtB;AAAA,MAEtBE,KAFsB,oBAE5BjE,IAF4B;AAAA,MAENkE,QAFM,oBAEfJ,OAFe;;AAAA,mBAGsBU,SAAS,CAAyB,mBAAzB,CAH/B;AAAA,MAGrBiF,YAHqB,cAG5BhF,KAH4B;AAAA,MAGEiF,eAHF,cAGP5F,OAHO;;AAAA,oBAIbjC,2BAAU,CAAC8H,wCAAD,CAJG;AAAA,MAI5BC,UAJ4B,eAI5BA,UAJ4B;;AAMpC,MAAMC,kBAAkB;AAAA,qGAAG,kBAAOC,KAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AACjBC,kBADiB,GACVD,KAAK,CAAC,CAAD,CADK;;AAAA,mBAEnBC,IAFmB;AAAA;AAAA;AAAA;;AAAA;AAIfP,0BAAY,CAAC,IAAD,CAAZ;AAJe;AAAA,qBAKTtF,QAAQ,CAAC6F,IAAD,CALC;;AAAA;AAAA;AAOfP,0BAAY,CAAC,KAAD,CAAZ;AAPe;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAH;;AAAA,oBAAlBK,kBAAkB;AAAA;AAAA;AAAA,KAAxB;;AAWA,MAAMG,gBAAgB;AAAA,qGAAG;AAAA;AAAA;AAAA;AAAA;AAAA;AAEjBR,0BAAY,CAAC,IAAD,CAAZ;AAFiB;AAAA,qBAGXtF,QAAQ,CAACpG,SAAD,CAHG;;AAAA;AAAA;AAKjB0L,0BAAY,CAAC,KAAD,CAAZ;AALiB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAH;;AAAA,oBAAhBQ,gBAAgB;AAAA;AAAA;AAAA,KAAtB;;AAQA,MAAMC,uBAAuB;AAAA,qGAAG,kBAAOH,KAAP;AAAA;AAAA;AAAA;AAAA;AAAA;AACtBC,kBADsB,GACfD,KAAK,CAAC,CAAD,CADU;;AAAA,mBAExBC,IAFwB;AAAA;AAAA;AAAA;;AAAA;AAIpBP,0BAAY,CAAC,IAAD,CAAZ;AAJoB;AAAA,qBAKdE,eAAe,CAACK,IAAD,CALD;;AAAA;AAAA;AAOpBP,0BAAY,CAAC,KAAD,CAAZ;AAPoB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAH;;AAAA,oBAAvBS,uBAAuB;AAAA;AAAA;AAAA,KAA7B;;AAWA,MAAMC,wBAAwB;AAAA,qGAAG;AAAA;AAAA;AAAA;AAAA;AAAA;AAEzBV,0BAAY,CAAC,IAAD,CAAZ;AAFyB;AAAA,qBAGnBE,eAAe,CAAC5L,SAAD,CAHI;;AAAA;AAAA;AAKzB0L,0BAAY,CAAC,KAAD,CAAZ;AALyB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAH;;AAAA,oBAAxBU,wBAAwB;AAAA;AAAA;AAAA,KAA9B;;AAQA,MAAMC,eAAe,GAAG,SAAlBA,eAAkB,CAAClG,KAAD;AAAA,6GAAkB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAElCuF,0BAAY,CAAC,IAAD,CAAZ;AACAhG,qBAAO,CAACC,GAAR,kBAA6BQ,KAA7B;AAHkC;AAAA,qBAIf2F,UAAU,CAACQ,QAAX,CAAoBnG,KAApB,CAJe;;AAAA;AAI5BJ,kBAJ4B;AAKlCL,qBAAO,CAACC,GAAR,mBAA8BI,IAA9B;;AACA,kBAAIA,IAAJ,EAAU;AACNK,wBAAQ,CAACL,IAAD,CAAR;AACH;;AARiC;AAAA;AAWlC2F,0BAAY,CAAC,KAAD,CAAZ;AAXkC;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAlB;AAAA,GAAxB;;AAcA,MAAMa,4BAA4B,GAAG,SAA/BA,4BAA+B,CAACpG,KAAD;AAAA,6GAAkB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAE/CuF,0BAAY,CAAC,IAAD,CAAZ;AACAhG,qBAAO,CAACC,GAAR,kBAA6BQ,KAA7B;AAH+C;AAAA,qBAI5B2F,UAAU,CAACQ,QAAX,CAAoBnG,KAApB,CAJ4B;;AAAA;AAIzCJ,kBAJyC;AAK/CL,qBAAO,CAACC,GAAR,mBAA8BI,IAA9B;;AACA,kBAAIA,IAAJ,EAAU;AACN6F,+BAAe,CAAC7F,IAAD,CAAf;AACH;;AAR8C;AAAA;AAW/C2F,0BAAY,CAAC,KAAD,CAAZ;AAX+C;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAlB;AAAA,GAArC;;AAeA,MAAMc,MAAM,GAAGrI,oCAAS,CAAC2H,UAAD,EAAa,UAAAW,CAAC;AAAA,WAAIA,CAAJ,aAAIA,CAAJ,uBAAIA,CAAC,CAAED,MAAH,EAAJ;AAAA,GAAd,CAAxB;AACA,MAAME,mBAAmB,GAAGvI,oCAAS,CAAC2H,UAAD,EAAa,UAAAW,CAAC;AAAA,WAAIA,CAAJ,aAAIA,CAAJ,uBAAIA,CAAC,CAAEC,mBAAH,EAAJ;AAAA,GAAd,CAArC;AAEA,sBAAO,2EACH,2DADG,eAEH,0HACoE,8BAAC,IAAD;AAAM,MAAE,EAAC;AAAT,yBADpE,MAFG,eAKH,0EALG,eAMH,4GAAqD,sDAArD,WANG,EAOFvG,KAAK,iBAAI,8BAAC,wBAAD;AAAO,YAAQ,EAAE;AAAjB,uBAA2C6E,oCAAU,CAAC7E,KAAK,CAACwG,UAAP,CAArD,MAPP,EAQFxG,KAAK,iBAAI,wCARP,eASH,8BAAC,2BAAD,qBAAU,8BAAC,YAAD;AAAc,YAAQ,EAAEsF,SAAxB;AAAmC,QAAI,EAAE,cAAzC;AAAyD,mBAAe,EAAEM;AAA1E,IAAV,CATG,eAUH,8BAAC,kCAAD;AAAQ,kBAAW,aAAnB;AAAiC,YAAQ,EAAEN,SAA3C;AAAsD,WAAO,EAAES;AAA/D,mBAVG,EAWF,CAAAM,MAAM,SAAN,IAAAA,MAAM,WAAN,YAAAA,MAAM,CAAEjI,MAAR,kBAAkB,8BAAC,uBAAD,QACdiI,MAAM,CAACtN,GAAP,CAAW,UAAAiH,KAAK;AAAA,wBAAI,8BAAC,2BAAD;AAAU,SAAG,EAAEA,KAAK,CAACyG,IAArB;AAA2B,YAAM,MAAjC;AAAkC,aAAO,EAAEP,eAAe,CAAClG,KAAD;AAA1D,oBACjB,8BAAC,+BAAD;AAAc,aAAO,EAAEA,KAAK,CAAC0G,IAA7B;AAAmC,eAAS,EAAK1G,KAAK,CAACyG,IAAX,SAAmB5B,oCAAU,CAAC7E,KAAK,CAAC2G,IAAP;AAAzE,MADiB,CAAJ;AAAA,GAAhB,CADc,CAXhB,eAgBH,8DAhBG,eAiBH,qGAA8C,uDAA9C,WAjBG,EAkBFnB,YAAY,iBAAI,8BAAC,wBAAD;AAAO,YAAQ,EAAE;AAAjB,mCAlBd,EAmBFA,YAAY,iBAAI,8BAAC,0BAAD;AAA4B,UAAM,EAAEA;AAApC,IAnBd,EAoBFA,YAAY,iBAAI,wCApBd,eAqBH,8BAAC,2BAAD,qBAAU,8BAAC,YAAD;AAAc,YAAQ,EAAEF,SAAxB;AAAmC,QAAI,EAAE,sBAAzC;AAAiE,mBAAe,EAAEU;AAAlF,IAAV,CArBG,eAsBH,8BAAC,kCAAD;AAAQ,kBAAW,qBAAnB;AAAyC,YAAQ,EAAEV,SAAnD;AAA8D,WAAO,EAAEW;AAAvE,2BAtBG,EAuBF,CAAAM,mBAAmB,SAAnB,IAAAA,mBAAmB,WAAnB,YAAAA,mBAAmB,CAAEnI,MAArB,kBAA+B,8BAAC,uBAAD,QAC3BmI,mBAAmB,CAACxN,GAApB,CAAwB,UAAA6N,OAAO;AAAA,wBAAI,8BAAC,2BAAD;AAAU,SAAG,EAAEA,OAAO,CAACH,IAAvB;AAA6B,YAAM,MAAnC;AAAoC,aAAO,EAAEL,4BAA4B,CAACQ,OAAD;AAAzE,oBAChC,8BAAC,+BAAD;AAAc,aAAO,EAAEA,OAAO,CAACF,IAA/B;AAAqC,eAAS,EAAKE,OAAO,CAACH,IAAb,SAAqB5B,oCAAU,CAAC+B,OAAO,CAACD,IAAT;AAA7E,MADgC,CAAJ;AAAA,GAA/B,CAD2B,CAvB7B,eA4BH,sFA5BG,eA6BH,8BAAC,+BAAD;AAAc,gBAAY,EAAE7F,sCAAgBA;AAA5C,IA7BG,eA8BH,8BAAC,8BAAD;AACI,gBAAY,EAAEA,sCADlB;AAEI,WAAO,EAAE,iBAAAjJ,OAAO;AAAA,0BAAI,8BAAC,YAAD;AAAc,eAAO,EAAEA;AAAvB,QAAJ;AAAA,KAFpB;AAGI,WAAO,EAAE,iBAAAA,OAAO;AAAA;;AAAA,0BAAI,8BAAC,YAAD;AAChB,eAAO,EAAEA,OADO;AAEhB,aAAK,EAAEmI,KAFS;AAGhB,+BAAuB,EAAEnI,OAAF,aAAEA,OAAF,gDAAEA,OAAO,CAAEyF,MAAT,CAAgBS,QAAhB,CAAyB;AAAE5E,sBAAY,EAAE0N,2CAAqBA;AAArC,SAAzB,CAAF,0DAAE,sBAAoE,CAApE,CAHT;AAIhB,mBAAW,EAAErB;AAJG,QAAJ;AAAA;AAHpB,IA9BG,CAAP;AAyCH,C","file":"component---src-pages-tools-model-uploader-tsx-6412ea875933f1eb9776.js","sourcesContent":["import { SensorAggregatorReg, SensorAggregatorSampleType } from \"../../jacdac-spec/dist/specconstants\"\nimport { bufferToArray, NumberFormat } from \"./buffer\"\nimport { JD_SERIAL_MAX_PAYLOAD_SIZE, REPORT_RECEIVE } from \"./constants\"\nimport { jdpack } from \"./pack\"\nimport { JDRegister } from \"./register\"\nimport { JDService } from \"./service\"\nimport { JDServiceClient } from \"./serviceclient\"\nimport { isReading, serviceSpecificationFromClassIdentifier } from \"./spec\"\nimport { bufferConcat, bufferConcatMany, fromHex } from \"./utils\"\n\nexport interface SensorAggregatorInputConfig {\n    serviceClass: number;\n    // if specified, also specify serviceIndex\n    deviceId?: string;\n    serviceIndex?: number;\n}\n\nexport interface SensorAggregatorConfig {\n    samplingInterval: number; // ms\n    samplesInWindow: number;\n    inputs: SensorAggregatorInputConfig[];\n}\n\nexport interface SensorAggregatorStats {\n    \"numSamples\": number;\n    \"sampleSize\": number;\n}\n\nexport class SensorAggregatorClient extends JDServiceClient {\n    constructor(service: JDService) {\n        super(service)\n        this.service.registersUseAcks = true\n    }\n\n    async setInputs(cfg: SensorAggregatorConfig) {\n        function error(msg: string) {\n            throw new Error(\"Aggregator inputs: \" + msg)\n        }\n        function mapType(tp: number) {\n            switch (tp) {\n                case 1: return SensorAggregatorSampleType.U8\n                case 2: return SensorAggregatorSampleType.U16\n                case 4: return SensorAggregatorSampleType.U32\n                case -1: return SensorAggregatorSampleType.I8\n                case -2: return SensorAggregatorSampleType.I16\n                case -4: return SensorAggregatorSampleType.I32\n                default:\n                    error(\"unknown storage type\")\n            }\n        }\n\n        if (!cfg || !cfg.inputs)\n            error(\"invalid input format\");\n\n        let totalSampleSize = 0\n        const inputs = cfg.inputs?.map(input => {\n            const { deviceId, serviceIndex, serviceClass } = input\n            if (!!deviceId !== !!serviceIndex)\n                error(`deviceId and serviceIndex must be specified together`)\n            const specification = serviceSpecificationFromClassIdentifier(serviceClass)\n            if (!specification)\n                error(`missing specification from service 0x${serviceClass.toString(16)}`)\n            const freeze = !!deviceId\n            const readingReg = specification.packets.find(isReading)\n            if (!readingReg)\n                error(`service 0x${serviceClass.toString(16)} does not have a reading register`)\n            let sampleType: SensorAggregatorSampleType = undefined\n            let sampleSize = 0\n            let sampleShift = 0\n            for (const field of readingReg.fields) {\n                sampleSize += Math.abs(field.storage)\n                if (sampleType === undefined) {\n                    sampleType = mapType(field.storage)\n                    sampleShift = field.shift || 0\n                }\n                if (sampleType != mapType(field.storage) || sampleShift != (field.shift || 0))\n                    error(\"heterogenous field types\")\n            }\n            totalSampleSize += sampleSize\n            return bufferConcat(\n                freeze ? fromHex(deviceId) : new Uint8Array(8),\n                jdpack(\"u32 u8 u8 u8 i8\", [\n                    serviceClass,\n                    freeze ? serviceIndex : 0,\n                    sampleSize,\n                    sampleType,\n                    sampleShift\n                ])\n            )\n        })\n\n        if (totalSampleSize > JD_SERIAL_MAX_PAYLOAD_SIZE)\n            error(\"samples won't fit in packet\")\n\n        // u32 is x[4]\n        inputs.unshift(jdpack(\"u16 u16 u32\", [cfg.samplingInterval, cfg.samplesInWindow, 0]))\n        await this.service.register(SensorAggregatorReg.Inputs)\n            .sendSetAsync(bufferConcatMany(inputs))\n    }\n\n    async collect(numSamples: number) {\n        await this.service.register(SensorAggregatorReg.StreamingSamples)\n            .sendSetPackedAsync(\"u32\", [numSamples]);\n    }\n\n    subscribeSample(handler: (sample: number[]) => void): () => void {\n        const reg = this.service.register(SensorAggregatorReg.CurrentSample)\n        return this.mount(reg.subscribe(REPORT_RECEIVE,\n            () => handler(bufferToArray(reg.data, NumberFormat.Float32LE))))\n    }\n\n    private async getReg(id: SensorAggregatorReg, f: (v: JDRegister) => any) {\n        const reg = this.service.register(id)\n        await reg.refresh()\n        return f(reg)\n    }\n\n    async stats(): Promise<SensorAggregatorStats> {\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        const info: any = {\n            \"numSamples\": this.getReg(SensorAggregatorReg.NumSamples, r => r.intValue),\n            \"sampleSize\": this.getReg(SensorAggregatorReg.SampleSize, r => r.intValue),\n        }\n        for (const id of Object.keys(info)) {\n            info[id] = await info[id]\n        }\n        return info\n    }\n}\n\n","\nimport React, { useContext } from 'react';\nimport { Grid, makeStyles, Theme, createStyles, CardContent, Card, CardActions, Switch, Box } from '@material-ui/core';\nimport ServiceCard from './ServiceCard';\nimport useChange from '../jacdac/useChange';\nimport JacdacContext, { JacdacContextProps } from \"../jacdac/Context\";\nimport useGridBreakpoints from './useGridBreakpoints';\nimport DeviceCardHeader from './DeviceCardHeader';\nimport { JDService } from '../../jacdac-ts/src/jdom/service';\nimport { DeviceLostAlert } from './alert/DeviceLostAlert';\nimport { JDDevice } from '../../jacdac-ts/src/jdom/device';\nimport Alert from './ui/Alert';\n\n\nfunction ServiceListItem(props: {\n    service: JDService,\n    content?: JSX.Element | JSX.Element[],\n    checked?: boolean,\n    checkedDisabled?: boolean\n    toggleChecked?: () => void,\n    actions?: JSX.Element | JSX.Element[]\n}) {\n    const { service, content, checked, checkedDisabled, toggleChecked, actions } = props;\n    const { device } = service;\n\n    const handleCheck = () => toggleChecked()\n\n    return <Card>\n        <DeviceCardHeader device={device} showMedia={true} />\n        <CardContent>\n            <DeviceLostAlert device={device} />\n            {content}\n        </CardContent>\n        <CardActions>\n            {checked !== undefined && <Switch disabled={checkedDisabled} onChange={handleCheck} checked={checked} />}\n            {actions}\n        </CardActions>\n    </Card>\n}\n\nexport default function ServiceList(props: {\n    serviceClass: number,\n    selected?: (service: JDService) => boolean,\n    toggleSelected?: (service: JDService) => void,\n    content?: (service: JDService) => JSX.Element | JSX.Element[],\n    actions?: (service: JDService) => JSX.Element | JSX.Element[],\n    alertMissing?: string\n}) {\n    const { serviceClass, selected, toggleSelected, content, actions, alertMissing } = props\n    const { bus } = useContext<JacdacContextProps>(JacdacContext)\n    const services = useChange(bus, n => n.services({ serviceClass }))\n    const gridBreakpoints = useGridBreakpoints(services?.length)\n\n    const handleSelected = (service: JDService) => selected && selected(service)\n    const handleChecked = (service: JDService) => () => toggleSelected && toggleSelected(service);\n    const serviceContent = (service: JDService) => content && content(service);\n    const serviceActions = (service: JDService) => actions && actions(service);\n\n    if (alertMissing && !services?.length)\n        return <Alert severity=\"info\">{alertMissing}</Alert>\n\n    return (<Box mb={1}>\n        <Grid container spacing={2}>\n            {services?.map(service => <Grid key={service.id} item {...gridBreakpoints}>\n                <ServiceListItem\n                    service={service}\n                    checked={handleSelected(service)}\n                    toggleChecked={handleChecked(service)}\n                    content={serviceContent(service)}\n                    actions={serviceActions(service)}\n                />\n            </Grid>)}\n        </Grid></Box>\n    )\n}\n","import React, { useContext, useEffect, useState } from \"react\";\nimport { JSONTryParse, readBlobToText, readBlobToUint8Array } from \"../../jacdac-ts/src/jdom/utils\";\nimport DbContext, { DB_VALUE_CHANGE } from \"./DbContext\";\nimport useEffectAsync from \"./useEffectAsync\";\n\nexport function useDbBlob(id: string) {\n    const { db } = useContext(DbContext)\n    const [_value, _setValue] = useState<Blob>(undefined)\n    const values = db?.blobs\n\n    // listen to change\n    useEffect(() => {\n        let _mounted = true;\n        return values?.subscribe(DB_VALUE_CHANGE, async (changed) => {\n            if (changed === id) {\n                try {\n                    const v = await values.get(id)\n                    if (_mounted) {\n                        _setValue(v);\n                    }\n                }\n                catch (e) {\n                    console.log(e)\n                    await values?.set(id, undefined);\n                }\n            }\n            return () => {\n                _mounted = false;\n            }\n        })\n    }, [values])\n\n    // load intial value\n    useEffectAsync(async (mounted) => {\n        try {\n            const v = await values?.get(id);\n            if (mounted())\n                _setValue(v)\n        } catch (e) {\n            console.log(e)\n            // trash data\n            await values?.set(id, undefined);\n        }\n    }, [values])\n\n    return {\n        blob: _value,\n        setBlob: async (blob: Blob) => {\n            await values?.set(id, blob)\n        }\n    }\n}\n\nexport function useDbUint8Array(blobName: string) {\n    const { blob, setBlob } = useDbBlob(blobName)\n    const [model, setModel] = useState<Uint8Array>(undefined)\n\n    useEffectAsync(async (mounted) => {\n        if (!blob) {\n            setModel(undefined)\n        }\n        else {\n            const buf = await readBlobToUint8Array(blob);\n            if (mounted())\n                setModel(buf);\n        }\n    }, [blob])\n\n    return {\n        data: model,\n        setBlob\n    }\n}\n\nexport function useDbString(blobName: string) {\n    const { blob, setBlob } = useDbBlob(blobName)\n    const [model, setModel] = useState<string>(undefined)\n\n    useEffectAsync(async () => {\n        if (!blob) {\n            setModel(undefined)\n        }\n        else {\n            const t = await readBlobToText(blob);\n            setModel(t);\n        }\n    }, [blob])\n\n    return {\n        data: model,\n        setBlob\n    }\n}\n\nexport function useDbJSON<T>(blobName: string) {\n    const { data, setBlob } = useDbString(blobName);\n    const value: T = JSONTryParse(data) as T;\n    return {\n        value,\n        setBlob: async (blob: Blob) => {\n            await setBlob(blob)\n        }\n    }\n}\n","import * as U from \"./utils\"\nimport Packet from \"./packet\"\nimport {\n    REPORT_RECEIVE,\n    SRV_MODEL_RUNNER\n} from \"./constants\"\nimport { JDService } from \"./service\"\nimport { ModelRunnerCmd, ModelRunnerReg } from \"./constants\"\nimport { bufferToArray, NumberFormat } from \"./buffer\"\nimport { OutPipe } from \"./pipes\"\nimport { JDRegister } from \"./register\"\nimport { JDServiceClient } from \"./serviceclient\"\nimport { serviceSpecificationFromClassIdentifier } from \"./spec\"\nimport { jdunpack } from \"./pack\"\n\n/*\n    enum SampleType : u8 {\n        U8 = 0x08\n        I8 = 0x88\n        U16 = 0x10\n        I16 = 0x90\n        U32 = 0x20\n        I32 = 0xA0\n    }\n    rw inputs @ 0x80 {\n        sampling_interval: u16 ms\n        samples_in_window: u16\n        reserved: u32\n    repeats:\n        device_id: devid\n        service_class: u32\n        service_num: u8\n        sample_size: u8 B\n        sample_type: SampleType\n        sample_shift: i8\n    }\n*/\n\nexport function isMLModelSupported(model: Uint8Array, formatRegValue: number) {\n    return U.read32(model, 0) == formatRegValue || U.read32(model, 4) == formatRegValue\n}\n\nexport function getMLModelFormatName(model: Uint8Array) {\n    const map = serviceSpecificationFromClassIdentifier(SRV_MODEL_RUNNER).enums[\"ModelFormat\"].members\n    const m0 = U.read32(model, 0)\n    const m1 = U.read32(model, 4)\n    for (const v of Object.keys(map)) {\n        if (map[v] == m0 || map[v] == m1)\n            return v\n    }\n    return \"0x\" + U.toHex(model.slice(0, 8))\n}\n\nexport class ModelRunnerClient extends JDServiceClient {\n    constructor(service: JDService) {\n        super(service)\n        this.service.registersUseAcks = true\n    }\n\n    // TODO this should use some caching?\n    async isModelSupported(model: Uint8Array) {\n        const reg = this.service.register(ModelRunnerReg.Format)\n        await reg.refresh()\n        return reg.data == null || isMLModelSupported(model, reg.intValue >>> 0)\n    }\n\n    subscribeResults(handler: (sample: number[]) => void): () => void {\n        const reg = this.service.register(ModelRunnerReg.Outputs)\n        return reg.subscribe(REPORT_RECEIVE, () => {\n            handler(bufferToArray(reg.data, NumberFormat.Float32LE))\n        })\n    }\n\n    async deployModel(model: Uint8Array, onProgress?: (p: number) => void) {\n        onProgress?.(0)\n        const resp = await this.service.sendCmdAwaitResponseAsync(Packet.jdpacked(ModelRunnerCmd.SetModel, \"u32\", [model.length]), 3000)\n        onProgress?.(0.05)\n        const [pipePort] = jdunpack<[number]>(resp.data, \"u16\")\n        if (!pipePort)\n            throw new Error(\"wrong port \" + pipePort)\n        const pipe = new OutPipe(this.service.device, pipePort)\n        const chunkSize = 224 // has to be divisible by 8\n        for (let i = 0; i < model.length; i += chunkSize) {\n            await pipe.send(model.slice(i, i + chunkSize))\n            onProgress?.(0.05 + (i / model.length) * 0.9)\n        }\n        try {\n            await pipe.close()\n        } catch {\n            // the device may restart before we manage to close\n        }\n        onProgress?.(1)\n    }\n\n    async autoInvoke(everySamples = 1) {\n        await this.service.register(ModelRunnerReg.AutoInvokeEvery).sendSetPackedAsync(\"u16\", [everySamples])\n    }\n\n    private async getReg(id: ModelRunnerReg, f: (v: JDRegister) => any) {\n        const reg = this.service.register(id)\n        await reg.refresh()\n        return f(reg)\n    }\n\n    async modelStats(): Promise<TFModelStats> {\n        const info: any = {\n            \"modelSize\": this.getReg(ModelRunnerReg.ModelSize, r => r.intValue),\n            \"arenaSize\": this.getReg(ModelRunnerReg.AllocatedArenaSize, r => r.intValue),\n            \"inputShape\": this.getReg(ModelRunnerReg.InputShape, r => bufferToArray(r.data, NumberFormat.UInt16LE)),\n            \"outputShape\": this.getReg(ModelRunnerReg.OutputShape, r => bufferToArray(r.data, NumberFormat.UInt16LE)),\n            \"lastError\": this.getReg(ModelRunnerReg.LastError, r => U.uint8ArrayToString(r.data)),\n        }\n        for (const id of Object.keys(info)) {\n            info[id] = await info[id]\n        }\n        return info\n    }\n}\n\nexport interface TFModelStats {\n    \"modelSize\": number;\n    \"arenaSize\": number;\n    \"inputShape\": number[];\n    \"outputShape\": number[];\n    \"lastError\": string;\n}\n\n/*\nexport async function testAGG(bus: JDBus) {\n    const aggService = bus.services({ serviceClass: SRV_SENSOR_AGGREGATOR })[0]\n    if (!aggService) {\n        console.log(\"no agg service\")\n        return\n    }\n    const agg = new SensorAggregatorClient(aggService)\n\n    let acc = bus.services({ serviceClass: SRV_ACCELEROMETER })\n    if (acc.length == 0) {\n        console.log(\"no acc service\")\n        return\n    }\n\n    await agg.setInputs({\n        samplesInWindow: 50,\n        samplingInterval: 20,\n        inputs: acc\n    })\n\n    agg.subscribeSample(sample => {\n        console.log(\"SAMPLE\", sample)\n    })\n\n}\n\nexport async function testTF(bus: JDBus, model: Uint8Array) {\n    const tfService = bus.services({ serviceClass: SRV_MODEL_RUNNER })[0]\n    if (!tfService) {\n        console.log(\"no tflite service\")\n        return\n    }\n    const tf = new TFLiteClient(tfService)\n\n    if (model)\n        await tf.deployModel(model, p => console.log(\"deploy\", p.toFixed(3)))\n\n    const st = await tf.modelStats()\n    console.log(st)\n\n    const classNames = ['noise', 'punch', 'left', 'right'];\n    tf.subscribeResults(outp => {\n        for (let i = 0; i < outp.length; ++i) {\n            if (outp[i] > 0.7) {\n                console.log(outp[i].toFixed(3) + \" \" + classNames[i])\n            }\n        }\n         console.log(\"OUT\", outp)\n    })\n\n    await tf.autoInvoke(8)\n\n    console.log(\"autoinvoked\")\n\n}\n*/\n","import { Paper } from \"@material-ui/core\";\nimport React, { useContext } from \"react\"\nimport { serviceName } from \"../../jacdac-ts/src/jdom/pretty\";\nimport { SensorAggregatorConfig, SensorAggregatorInputConfig } from \"../../jacdac-ts/src/jdom/sensoraggregatorclient\"\nimport JacdacContext, { JacdacContextProps } from \"../jacdac/Context\";\nimport DeviceName from \"./DeviceName\";\n\nfunction SensorAggregatorInputConfigView(props: { input: SensorAggregatorInputConfig }) {\n    const { bus } = useContext<JacdacContextProps>(JacdacContext);\n    const { input } = props;\n    const { serviceClass, deviceId, serviceIndex } = input;\n\n    const device = deviceId && bus.device(deviceId)\n\n    return <>\n        {serviceName(serviceClass)}\n        {device && <DeviceName device={device} serviceIndex={serviceIndex} />}\n        {!device && deviceId && <span>{deviceId}[{serviceIndex}]</span>}\n        {!deviceId && <span>/ any device</span>}\n    </>\n}\n\nexport default function SensorAggregatorConfigView(props: { config: SensorAggregatorConfig }) {\n    const { config } = props;\n\n    if (!config?.inputs)\n        return <></>\n\n    return <Paper>\n        <ul>\n            <li>samples interval (ms): <code>{config.samplingInterval}</code></li>\n            <li>samples window (# samples): <code>{config.samplesInWindow}</code></li>\n            <li>inputs ({config.inputs.length})\n                <ul>\n                    {config.inputs.map((input, i) => <li key={\"input\" + i}><SensorAggregatorInputConfigView input={input} /></li>)}\n                </ul>\n            </li>\n        </ul>\n    </Paper>\n}","import React, { useContext, useState } from \"react\";\nimport Alert from \"./ui/Alert\";\nimport AppContext from \"./AppContext\";\n\nexport type ProgressHandler = (p: number) => void\n\nexport default function useCall() {\n    const { setError: setAppError } = useContext(AppContext)\n    const [error, setError] = useState<Error>();\n    const [running, setRunning] = useState(false)\n    const [progress, setProgress] = useState(0);\n\n    const handleProgress = (p: number) => setProgress(p);\n\n    const call = (handler: (onProgress?: ProgressHandler) => void) => {\n        try {\n            setRunning(true)\n            setError(undefined)\n            handler(handleProgress);\n        } catch (e) {\n            setError(e)\n            setAppError(e)\n        }\n        finally {\n            setRunning(false)\n        }\n    }\n    const callAsync = async (handler: (onProgress?: (p: number) => void) => Promise<void>) => {\n        try {\n            setRunning(true)\n            setError(undefined)\n            await handler(handleProgress);\n        } catch (e) {\n            setError(e)\n            setAppError(e)\n        }\n        finally {\n            setRunning(false)\n        }\n    }\n    const alert = error && <Alert severity=\"error\">{error}</Alert>\n\n    return {\n        running,\n        error,\n        progress,\n        alert,\n        call,\n        callAsync\n    }\n} ","import * as React from 'react';\nimport createSvgIcon from './utils/createSvgIcon';\nexport default createSvgIcon( /*#__PURE__*/React.createElement(\"path\", {\n  d: \"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z\"\n}), 'Link');","import { List, ListItem, ListItemText, Typography } from '@material-ui/core';\nimport React, { lazy, useContext, useState } from 'react';\nimport { SRV_SENSOR_AGGREGATOR, SRV_MODEL_RUNNER, ModelRunnerReg } from '../../../jacdac-ts/src/jdom/constants';\nimport { JDService } from '../../../jacdac-ts/src/jdom/service';\nimport ServiceList from '../../components/ServiceList';\nimport ConnectAlert from '../../components/alert/ConnectAlert'\nimport { useDbJSON, useDbUint8Array } from '../../components/useDb'\nimport Alert from \"../../components/ui/Alert\";\nimport { Button } from 'gatsby-theme-material-ui';\nimport { ModelRunnerClient } from '../../../jacdac-ts/src/jdom/modelrunner'\nimport RegisterInput from '../../components/RegisterInput';\nimport CircularProgressWithLabel from '../../components/ui/CircularProgressWithLabel'\nimport { SensorAggregatorClient, SensorAggregatorConfig } from '../../../jacdac-ts/src/jdom/sensoraggregatorclient';\nimport SensorAggregatorConfigView from '../../components/SensorAggregatorConfigView';\nimport ServiceManagerContext from '../../components/ServiceManagerContext'\nimport useChange from '../../jacdac/useChange';\nimport { IFile } from '../../../jacdac-ts/src/embed/protocol';\nimport { prettySize } from '../../../jacdac-ts/src/jdom/pretty';\nimport RegisterTrend from '../../components/RegisterTrend';\nimport { useRegisterIntValue, useRegisterStringValue } from '../../jacdac/useRegisterValue';\nimport useCall from '../../components/useCall';\n\nimport Suspense from \"../../components/ui/Suspense\"\nimport { Link } from '@material-ui/icons';\nconst ImportButton = lazy(() => import(\"../../components/ImportButton\"))\n\nexport function ModelContent(props: { service: JDService }) {\n    const { service } = props\n    const modelSize = useRegisterIntValue(service.register(ModelRunnerReg.ModelSize));\n    const lastError = useRegisterStringValue(service.register(ModelRunnerReg.LastError));\n\n    return <>\n        {lastError && <Alert severity=\"warning\">{lastError}</Alert>}\n        <Typography>model size: {modelSize === undefined ? \"...\" : prettySize(modelSize)}</Typography>\n        <RegisterInput register={service.register(ModelRunnerReg.AutoInvokeEvery)} />\n        <RegisterTrend showName register={service.register(ModelRunnerReg.Outputs)} mini={true} />\n    </>\n}\n\nexport function ModelActions(props: {\n    service: JDService,\n    model: Uint8Array,\n    sensorAggregatorService?: JDService,\n    sensorInput?: SensorAggregatorConfig\n}) {\n    const { service, model, sensorAggregatorService, sensorInput } = props\n    const { running, progress, alert, callAsync } = useCall();\n\n    const modelDisabled = !service || !model || running\n\n    const handleDeployModel = async () => await callAsync(async (setProgress) => {\n        if (sensorAggregatorService && sensorInput) {\n            const aggregator = new SensorAggregatorClient(sensorAggregatorService)\n            await aggregator.setInputs(sensorInput)\n        }\n        if (service && model) {\n            const runner = new ModelRunnerClient(service)\n            await runner.deployModel(model, setProgress)\n        }\n    })\n\n    return <>\n        {!running && <Button disabled={modelDisabled} variant=\"contained\" color=\"primary\" onClick={handleDeployModel}>\n            {sensorInput ? \"Deploy model and configuration\" : \"Deploy model\"}\n        </Button>}\n        {running && <CircularProgressWithLabel value={progress * 100} />}\n        {alert}\n    </>\n}\n\nexport default function ModelUploader() {\n    const [importing, setImporting] = useState(false)\n    const { data: model, setBlob: setModel } = useDbUint8Array(\"model.tflite\")\n    const { value: sensorConfig, setBlob: setSensorConfig } = useDbJSON<SensorAggregatorConfig>(\"sensor-input.json\")\n    const { modelStore } = useContext(ServiceManagerContext)\n\n    const handleTfmodelFiles = async (files: File[]) => {\n        const file = files[0]\n        if (file) {\n            try {\n                setImporting(true)\n                await setModel(file)\n            } finally {\n                setImporting(false)\n            }\n        }\n    }\n    const handleClearModel = async () => {\n        try {\n            setImporting(true)\n            await setModel(undefined)\n        } finally {\n            setImporting(false)\n        }\n    }\n    const handleSensorConfigFiles = async (files: File[]) => {\n        const file = files[0]\n        if (file) {\n            try {\n                setImporting(true)\n                await setSensorConfig(file)\n            } finally {\n                setImporting(false)\n            }\n        }\n    }\n    const handleClearConfiguration = async () => {\n        try {\n            setImporting(true)\n            await setSensorConfig(undefined)\n        } finally {\n            setImporting(false)\n        }\n    }\n    const handleLoadModel = (model: IFile) => async () => {\n        try {\n            setImporting(true)\n            console.log(`loading model`, model)\n            const blob = await modelStore.loadFile(model);\n            console.log(`loaded content`, blob);\n            if (blob) {\n                setModel(blob)\n            }\n        }\n        finally {\n            setImporting(false)\n        }\n    }\n    const handleLoadInputConfiguration = (model: IFile) => async () => {\n        try {\n            setImporting(true)\n            console.log(`loading model`, model)\n            const blob = await modelStore.loadFile(model);\n            console.log(`loaded content`, blob);\n            if (blob) {\n                setSensorConfig(blob)\n            }\n        }\n        finally {\n            setImporting(false)\n        }\n    }\n\n    const models = useChange(modelStore, _ => _?.models());\n    const inputConfigurations = useChange(modelStore, _ => _?.inputConfigurations())\n\n    return <>\n        <h1>Model uploader</h1>\n        <p>\n            Upload Machine Learning Models (like TensorFlow Lite) into your <Link to=\"/services/model-runner/\">ML module runners</Link>.\n        </p>\n        <h3>Load a machine learning model</h3>\n        <p>Machine learning models are typically stored in a <code>.tflite</code> file.</p>\n        {model && <Alert severity={'success'}>Model loaded ({prettySize(model.byteLength)})</Alert>}\n        {model && <p />}\n        <Suspense><ImportButton disabled={importing} text={\"Import model\"} onFilesUploaded={handleTfmodelFiles} /></Suspense>\n        <Button aria-label=\"clear model\" disabled={importing} onClick={handleClearModel}>clear model</Button>\n        {models?.length && <List>\n            {models.map(model => <ListItem key={model.path} button onClick={handleLoadModel(model)}>\n                <ListItemText primary={model.name} secondary={`${model.path} ${prettySize(model.size)}`} />\n            </ListItem>)}\n        </List>}\n        <h3>Configure sensors</h3>\n        <p>Sensor configuration files are stored in a <code>.jd.json</code> file.</p>\n        {sensorConfig && <Alert severity={'success'}>Sensor configuration loaded</Alert>}\n        {sensorConfig && <SensorAggregatorConfigView config={sensorConfig} />}\n        {sensorConfig && <p />}\n        <Suspense><ImportButton disabled={importing} text={\"Import configuration\"} onFilesUploaded={handleSensorConfigFiles} /></Suspense>\n        <Button aria-label=\"clear configuration\" disabled={importing} onClick={handleClearConfiguration}>clear configuration</Button>\n        {inputConfigurations?.length && <List>\n            {inputConfigurations.map(iconfig => <ListItem key={iconfig.path} button onClick={handleLoadInputConfiguration(iconfig)}>\n                <ListItemText primary={iconfig.name} secondary={`${iconfig.path} ${prettySize(iconfig.size)}`} />\n            </ListItem>)}\n        </List>}\n        <h3>Deploy model to machine learning services</h3>\n        <ConnectAlert serviceClass={SRV_MODEL_RUNNER} />\n        <ServiceList\n            serviceClass={SRV_MODEL_RUNNER}\n            content={service => <ModelContent service={service} />}\n            actions={service => <ModelActions\n                service={service}\n                model={model}\n                sensorAggregatorService={service?.device.services({ serviceClass: SRV_SENSOR_AGGREGATOR })?.[0]}\n                sensorInput={sensorConfig}\n            />}\n        />\n    </>\n}"],"sourceRoot":""}