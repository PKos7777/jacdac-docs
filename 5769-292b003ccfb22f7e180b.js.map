{"version":3,"sources":["webpack://jacdac-docs/./node_modules/@material-ui/icons/VolumeDown.js","webpack://jacdac-docs/./node_modules/@material-ui/icons/VolumeUp.js","webpack://jacdac-docs/./src/components/hooks/usePlayTone.ts","webpack://jacdac-docs/./src/components/dashboard/DashboardBuzzer.tsx","webpack://jacdac-docs/./src/components/hooks/toneContext.ts"],"names":["usePlayTone","defaultVolume","context","useRef","useEffect","current","close","onClickActivateAudioContext","createToneContext","e","console","warn","setVolume","volume","playTone","frequency","duration","PianoWidget","lazy","DashboardBuzzer","props","service","server","useServiceServer","color","volumeRegister","useRegister","BuzzerReg","useRegisterUnpackedValue","subscribe","BuzzerServer","args","sendPlayTone","f","vol","period","duty","data","jdpack","sendCmdAsync","BuzzerCmd","handleChange","ev","newValue","sendSetPackedAsync","undefined","VOLUME_GAIN","log","ctx","window","AudioContext","webkitAudioContext","buffer","createBuffer","source","createBufferSource","connect","destination","start","createGain","gain","value","v","isNaN","tone","createOscillator","type","stop","currentTime","debug","state"],"mappings":"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","file":"5769-292b003ccfb22f7e180b.js","sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _interopRequireWildcard = require(\"@babel/runtime/helpers/interopRequireWildcard\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nvar React = _interopRequireWildcard(require(\"react\"));\n\nvar _createSvgIcon = _interopRequireDefault(require(\"./utils/createSvgIcon\"));\n\nvar _default = (0, _createSvgIcon.default)( /*#__PURE__*/React.createElement(\"path\", {\n  d: \"M18.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM5 9v6h4l5 5V4L9 9H5z\"\n}), 'VolumeDown');\n\nexports.default = _default;","\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nvar _interopRequireWildcard = require(\"@babel/runtime/helpers/interopRequireWildcard\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nvar React = _interopRequireWildcard(require(\"react\"));\n\nvar _createSvgIcon = _interopRequireDefault(require(\"./utils/createSvgIcon\"));\n\nvar _default = (0, _createSvgIcon.default)( /*#__PURE__*/React.createElement(\"path\", {\n  d: \"M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z\"\n}), 'VolumeUp');\n\nexports.default = _default;","import { useEffect, useRef } from \"react\"\nimport { createToneContext, ToneContext } from \"./toneContext\"\n\nexport default function usePlayTone(defaultVolume?: number) {\n    const context = useRef<ToneContext>()\n\n    // final cleanup\n    useEffect(() => {\n        return () => {\n            context.current?.close()\n        }\n    }, [])\n\n    // needs to be initiated in onClick on safari mobile\n    const onClickActivateAudioContext = () => {\n        if (context.current) return\n\n        try {\n            context.current = createToneContext(defaultVolume)\n        } catch (e) {\n            console.warn(e)\n        }\n    }\n    const setVolume = (volume: number) => context.current?.setVolume(volume)\n    const playTone = (frequency: number, duration: number) =>\n        context.current?.playTone(frequency, duration)\n\n    return {\n        onClickActivateAudioContext,\n        setVolume,\n        playTone,\n    }\n}\n","import { Grid, Slider } from \"@material-ui/core\"\nimport React, { lazy, useEffect } from \"react\"\nimport { BuzzerCmd, BuzzerReg } from \"../../../jacdac-ts/src/jdom/constants\"\nimport { DashboardServiceProps } from \"./DashboardServiceWidget\"\nimport { jdpack } from \"../../../jacdac-ts/src/jdom/pack\"\nimport { useRegisterUnpackedValue } from \"../../jacdac/useRegisterValue\"\nimport useServiceServer from \"../hooks/useServiceServer\"\nimport usePlayTone from \"../hooks/usePlayTone\"\nimport BuzzerServer from \"../../../jacdac-ts/src/servers/buzzerserver\"\nimport VolumeDownIcon from \"@material-ui/icons/VolumeDown\"\nimport VolumeUpIcon from \"@material-ui/icons/VolumeUp\"\nimport Suspense from \"../ui/Suspense\"\nimport useRegister from \"../hooks/useRegister\"\nconst PianoWidget = lazy(() => import(\"../widgets/PianoWidget\"))\n\nexport default function DashboardBuzzer(props: DashboardServiceProps) {\n    const { service } = props\n    const server = useServiceServer<BuzzerServer>(service)\n    const color = server ? \"secondary\" : \"primary\"\n    const volumeRegister = useRegister(service, BuzzerReg.Volume)\n    const [volume] = useRegisterUnpackedValue<[number]>(volumeRegister, props)\n    const { playTone, setVolume, onClickActivateAudioContext } =\n        usePlayTone(volume)\n\n    // listen for playTone commands from the buzzer\n    useEffect(\n        () =>\n            server?.subscribe<[number, number]>(\n                BuzzerServer.PLAY_TONE,\n                args => {\n                    playTone?.(args[0], args[1])\n                }\n            ),\n        [server]\n    )\n\n    const sendPlayTone = async (f: number) => {\n        if (server) onClickActivateAudioContext() // enable audio context within click handler\n        const vol = 1\n        const period = 1000000 / f\n        const duty = (period * vol) / 2\n        const duration = 400\n        const data = jdpack<[number, number, number]>(\"u16 u16 u16\", [\n            period,\n            duty,\n            duration,\n        ])\n        await service.sendCmdAsync(BuzzerCmd.PlayTone, data)\n    }\n    const handleChange = async (ev: unknown, newValue: number | number[]) => {\n        volumeRegister.sendSetPackedAsync(\"u0.8\", [newValue], true)\n    }\n    useEffect(() => setVolume?.(volume), [volume])\n\n    return (\n        <>\n            <Grid item xs>\n                <Suspense>\n                    <PianoWidget playTone={sendPlayTone} />\n                </Suspense>\n            </Grid>\n            {volume !== undefined && (\n                <Grid item xs={12}>\n                    <Grid container spacing={2}>\n                        <Grid item>\n                            <VolumeDownIcon color=\"disabled\" />\n                        </Grid>\n                        <Grid item xs>\n                            <Slider\n                                valueLabelDisplay=\"off\"\n                                min={0}\n                                max={1}\n                                step={0.05}\n                                aria-label=\"volume\"\n                                value={volume}\n                                color={color}\n                                onChange={handleChange}\n                            />\n                        </Grid>\n                        <Grid item>\n                            <VolumeUpIcon color=\"disabled\" />\n                        </Grid>\n                    </Grid>\n                </Grid>\n            )}\n        </>\n    )\n}\n","const VOLUME_GAIN = 0.4\n\nexport interface ToneContext {\n    close: () => void\n    playTone: (frequency: number, duration: number) => void\n    setVolume: (vol: number) => void\n}\n\nexport function createToneContext(defaultVolume?: number): ToneContext {\n    try {\n        console.log(`create tone context`)\n        const ctx = new (window.AudioContext ||\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\n            (window as any).webkitAudioContext)()\n\n        // play silence sound within onlick to unlock it\n        const buffer = ctx.createBuffer(1, 1, 22050)\n        const source = ctx.createBufferSource()\n        source.buffer = buffer\n        source.connect(ctx.destination)\n        source.start()\n\n        // output node with volume\n        const volume = ctx.createGain()\n        volume.connect(ctx.destination)\n        volume.gain.value =\n            (defaultVolume !== undefined ? defaultVolume : 0.2) * VOLUME_GAIN\n\n        const setVolume = (v: number) => {\n            if (volume && !isNaN(v)) {\n                volume.gain.value = v * VOLUME_GAIN\n            }\n        }\n\n        const playTone = (frequency: number, duration: number) => {\n            try {\n                const tone = ctx.createOscillator()\n                tone.type = \"sawtooth\"\n                tone.connect(volume)\n                tone.frequency.value = frequency // update frequency\n                tone.start() // start and stop\n                tone.stop(ctx.currentTime + duration / 1000)\n            } catch (e) {\n                console.debug(e)\n            }\n        }\n\n        const close = () => {\n            try {\n                if (ctx.state === \"running\") ctx.close()\n            } catch (e) {\n                console.warn(e)\n            }\n        }\n\n        console.log(`tone context created`)\n\n        return {\n            setVolume,\n            playTone,\n            close,\n        }\n    } catch (e) {\n        return undefined\n    }\n}\n"],"sourceRoot":""}