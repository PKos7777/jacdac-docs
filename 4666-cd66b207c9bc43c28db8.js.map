{"version":3,"sources":["webpack://jacdac-docs/./src/components/hooks/useMicrophoneSpectrum.ts","webpack://jacdac-docs/./src/components/widgets/BytesBarGraphWidget.tsx","webpack://jacdac-docs/./src/components/dashboard/DashboardSoundSpectrum.tsx"],"names":["useMicrophoneSpectrum","enabled","options","useMicrophoneAnalyzer","analyser","onClickActivateMicrophone","closeMicrophone","frequencies","useRef","Uint8Array","useEffect","spectrum","a","current","length","frequencyBinCount","getByteFrequencyData","BytesBarGraphWidget","props","register","size","visible","server","useServiceServer","service","color","useWidgetTheme","background","controlBackground","active","pathRef","w","h","m","dy","subscribe","REPORT_UPDATE","bins","data","dx","dw","d","i","bin","setAttribute","HostMicrophoneButton","enabledRegister","useRegister","SoundSpectrumReg","minDecibelsRegister","maxDecibelsRegister","fftPow2SizeRegister","smoothingTimeConstantRegister","useRegisterBoolValue","useRegisterUnpackedValue","minDecibels","maxDecibels","fftPow2Size","fftSize","smoothingTimeConstant","title","handleClick","sendSetBoolAsync","REFRESH","v","undefined","reading","setValues","DashboardSoundSpectrum","frequencyBinsRegister"],"mappings":"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","file":"4666-cd66b207c9bc43c28db8.js","sourcesContent":["import { useEffect, useRef } from \"react\";\nimport { AudioAnalyzerOptions, useMicrophoneAnalyzer } from \"./useAudioAnalyzer\";\n\nexport default function useMicrophoneSpectrum(enabled: boolean, options?: AudioAnalyzerOptions) {\n    const { analyser, onClickActivateMicrophone, closeMicrophone } = useMicrophoneAnalyzer(options);\n    const frequencies = useRef(new Uint8Array(0));\n\n    useEffect(() => {\n        if (!enabled)\n            closeMicrophone();\n    }, [enabled]);\n\n    return {\n        onClickActivateMicrophone,\n        spectrum: () => {\n            const a = analyser();\n            if (!a) return frequencies.current;\n\n            if (frequencies.current.length !== a.frequencyBinCount)\n                frequencies.current = new Uint8Array(a.frequencyBinCount);\n            a?.getByteFrequencyData(frequencies.current);\n            return frequencies.current;\n        }\n    }\n}","import React, { useRef, useEffect } from \"react\"\nimport { REPORT_UPDATE } from \"../../../jacdac-ts/src/jdom/constants\"\nimport { JDRegister } from \"../../../jacdac-ts/src/jdom/register\"\nimport useServiceServer from \"../hooks/useServiceServer\"\nimport SvgWidget from \"./SvgWidget\"\nimport useWidgetTheme from \"./useWidgetTheme\"\n\nexport default function BytesBarGraphWidget(props: {\n    register: JDRegister\n    size?: string\n    visible: boolean\n}) {\n    const { register, size, visible } = props\n    const server = useServiceServer(register.service)\n    const color = server ? \"secondary\" : \"primary\"\n    const { background, controlBackground, active } = useWidgetTheme(color)\n    const pathRef = useRef<SVGPathElement>()\n\n    const w = 128\n    const h = w / 1.612\n    const m = 2\n    const dy = (h - 2 * m) / 0xff\n\n    useEffect(\n        () =>\n            visible &&\n            register?.subscribe(REPORT_UPDATE, () => {\n                // render outside of react loop\n                const { current } = pathRef\n                const bins = register.data\n                if (!current || !bins) return\n\n                const dx = (w - 2 * m) / bins.length\n                const dw = (w - 2 * m) / (bins.length * 6)\n                let d = `M ${m} ${h - m} `\n                for (let i = 0; i < bins.length; ++i) {\n                    const bin = bins[i]\n                    d += ` v ${-dy * bin} h ${dx - dw} v ${dy * bin} h ${dw}`\n                }\n                d += \" z\"\n                current.setAttribute(\"d\", d)\n            }),\n        [register, visible, pathRef.current]\n    )\n\n    return (\n        <SvgWidget width={w} height={h} size={size} background={background}>\n            <path\n                fill={active}\n                stroke={controlBackground}\n                strokeWidth={m / 2}\n                ref={pathRef}\n            />\n        </SvgWidget>\n    )\n}\n","import React, { useEffect } from \"react\"\nimport { DashboardServiceProps } from \"./DashboardServiceWidget\"\nimport {\n    useRegisterBoolValue,\n    useRegisterUnpackedValue,\n} from \"../../jacdac/useRegisterValue\"\nimport useServiceServer from \"../hooks/useServiceServer\"\nimport { Grid } from \"@material-ui/core\"\nimport MicIcon from \"@material-ui/icons/Mic\"\nimport {\n    REFRESH,\n    SoundSpectrumReg,\n} from \"../../../jacdac-ts/src/jdom/constants\"\nimport useMicrophoneSpectrum from \"../hooks/useMicrophoneSpectrum\"\nimport IconButtonWithProgress from \"../ui/IconButtonWithProgress\"\nimport { JDService } from \"../../../jacdac-ts/src/jdom/service\"\nimport SensorServer from \"../../../jacdac-ts/src/servers/sensorserver\"\nimport BytesBarGraphWidget from \"../widgets/BytesBarGraphWidget\"\nimport useRegister from \"../hooks/useRegister\"\n\nfunction HostMicrophoneButton(props: {\n    service: JDService\n    server?: SensorServer<[Uint8Array]>\n    visible: boolean\n}) {\n    const { server, service, visible } = props\n\n    const enabledRegister = useRegister(service, SoundSpectrumReg.Enabled)\n    const minDecibelsRegister = useRegister(\n        service,\n        SoundSpectrumReg.MinDecibels\n    )\n    const maxDecibelsRegister = useRegister(\n        service,\n        SoundSpectrumReg.MaxDecibels\n    )\n    const fftPow2SizeRegister = useRegister(\n        service,\n        SoundSpectrumReg.FftPow2Size\n    )\n    const smoothingTimeConstantRegister = useRegister(\n        service,\n        SoundSpectrumReg.SmoothingTimeConstant\n    )\n\n    const enabled = useRegisterBoolValue(enabledRegister, props)\n    const [minDecibels] = useRegisterUnpackedValue<[number]>(\n        minDecibelsRegister,\n        props\n    )\n    const [maxDecibels] = useRegisterUnpackedValue<[number]>(\n        maxDecibelsRegister,\n        props\n    )\n    const [fftPow2Size] = useRegisterUnpackedValue<[number]>(\n        fftPow2SizeRegister,\n        props\n    )\n    const fftSize = 1 << (fftPow2Size || 5)\n    const [smoothingTimeConstant] = useRegisterUnpackedValue<[number]>(\n        smoothingTimeConstantRegister,\n        props\n    )\n    const { spectrum, onClickActivateMicrophone } = useMicrophoneSpectrum(\n        enabled && !!server,\n        {\n            fftSize,\n            smoothingTimeConstant,\n            minDecibels,\n            maxDecibels,\n        }\n    )\n    const title = enabled ? \"Stop microphone\" : \"Start microphone\"\n\n    const handleClick = async () => {\n        if (!enabled && server) await onClickActivateMicrophone()\n        await enabledRegister.sendSetBoolAsync(!enabled, true)\n    }\n\n    // update volume on demand\n    useEffect(\n        () =>\n            visible &&\n            enabled &&\n            server?.subscribe(REFRESH, () => {\n                const v = spectrum?.()\n                if (v !== undefined) {\n                    server.reading.setValues([v], true)\n                }\n            }),\n        [server, spectrum, visible]\n    )\n\n    return (\n        <IconButtonWithProgress\n            aria-label={title}\n            title={title}\n            indeterminate={enabled}\n            onClick={handleClick}\n        >\n            <MicIcon />\n        </IconButtonWithProgress>\n    )\n}\n\nexport default function DashboardSoundSpectrum(props: DashboardServiceProps) {\n    const { service, visible } = props\n    const frequencyBinsRegister = useRegister(\n        service,\n        SoundSpectrumReg.FrequencyBins\n    )\n    const server = useServiceServer<SensorServer<[Uint8Array]>>(service)\n\n    return (\n        <Grid container direction=\"column\">\n            <Grid item>\n                <BytesBarGraphWidget\n                    visible={visible}\n                    register={frequencyBinsRegister}\n                />\n            </Grid>\n            <Grid item>\n                <HostMicrophoneButton\n                    service={service}\n                    server={server}\n                    visible={visible}\n                />\n            </Grid>\n        </Grid>\n    )\n}\n"],"sourceRoot":""}